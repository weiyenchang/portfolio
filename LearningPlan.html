<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
  <title data-i18n="pageTitle">學習計劃表</title>
  <style>
    /* CSS Variables for Theme - Refined for "Clean SaaS" Look */

    :root {
      /* Light Mode */
      --bg-body: #F5F7FA; /* 參考圖的淺灰背景 */
      --bg-gradient-start: #DCE5F9; /* 頂部藍紫色光暈 */
      --bg-gradient-end: rgba(255,255,255,0);
      
      --bg-card: #FFFFFF; /* 卡片白底 */
      --bg-input: #F0F2F5; /* 輸入框淺灰底 */
      
      --text-main: #111111; /* 主要文字全黑 */
      --text-secondary: #6B7280; /* 次要文字深灰 */
      
      --accent-black: #111111; /* 主要按鈕黑 */
      --accent-hover: #333333;
      
      --border-color: #E5E7EB; /* 極淡的邊框，大部分用陰影取代 */
      --border-focus: #111;
      
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.03);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.03);
      --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.05);

      --radius-lg: 24px; /* 卡片大圓角 */
      --radius-md: 16px; /* 輸入框圓角 */
      --radius-sm: 12px; /* 小元件圓角 */
      --radius-pill: 100px; /* 按鈕圓角 */

      --highlight-color: #FF7043; /* 週末/重點色 */
      --calendar-grid-line: #F0F0F0;
    }

    .dark-mode {
      /* Dark Mode - Apple/Modern Dark Style */
      --bg-body: #050505;
      --bg-gradient-start: #1a1b2e; /* 深色模式下的微光 */
      
      --bg-card: #1C1C1E; /* 深灰卡片 */
      --bg-input: #2C2C2E;
      
      --text-main: #FFFFFF;
      --text-secondary: #A1A1AA;
      
      --accent-black: #FFFFFF; /* 反轉按鈕顏色 */
      --accent-hover: #E5E5E5;
      
      --border-color: #333;
      --border-focus: #fff;
      
      --shadow-sm: none;
      --shadow-md: none;
      --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.5);

      --highlight-color: #FF8A65;
      --calendar-grid-line: #2C2C2E;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
      padding: 0;
      margin: 0;
      background-color: var(--bg-body); 
      color: var(--text-main);
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: relative;
      overflow-x: hidden; /* 防止光暈造成捲軸 */
    }

    /* 背景頂部光暈效果 (模擬參考圖) */
    body::before {
      content: '';
      position: absolute;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 400px;
      background: radial-gradient(ellipse at center, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 70%);
      filter: blur(80px);
      z-index: -1;
      pointer-events: none;
      opacity: 0.8;
    }
    
    .app-container {
        display: flex;
        min-height: 100vh;
    }

    /* 導航側邊欄 (左側小圖標) */
    .nav-sidebar {
        display: none !important; /* 原需求隱藏 */
        background-color: var(--bg-card);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
        width: 80px;
        flex-shrink: 0;
    }

    .main-content {
        flex: 1;
        padding: 40px;
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Header 區 */
    .header-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }
    .header-title-area {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    /* Logo / Icon 容器 - 圓形白底陰影 */
    .svg_icon {
        background: var(--bg-card);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-sm);
    }
    .svg_icon svg {
        fill: var(--text-main);
        transition: fill 0.3s ease;
        width: 24px;
        height: 24px;
    }

    h1 {
      font-size: 28px;
      letter-spacing: -0.5px; 
      font-weight: 700; 
      margin: 0;
      color: var(--text-main);
    }
    .header-title-area p {
        font-size: 14px;
        margin: 0;
        color: var(--text-secondary);
    }

    /* Header Controls (Right side) */
    .calendar-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    /* 圓形或藥丸形按鈕樣式 */
    .header_btn{
        display:flex;
    }
    .header_btn button {
        margin: 5px;
        border-radius: var(--radius-pill); 
        padding: 8px 16px; 
        font-size: 14px;
        font-weight: 500;
        background-color: var(--bg-card);
        border: 1px solid transparent; /* 移除邊框，改用陰影 */
        box-shadow: var(--shadow-sm);
        color: var(--text-main);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        height: 40px;
    }
    .header_btn button:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    .dark-mode .header_btn button {
        background-color: rgba(255,255,255,0.1);
        border: 1px solid var(--border-color);
    }

    /* 主體佈局 (側邊欄和日曆) */
    .container {
      display: flex;
      gap: 30px;
      margin-top: 20px;
    }
    .sidebar {
      flex: 1;
      max-width: 350px;
      min-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .main {
      flex: 3;
    }

    /* 輸入區卡片化 */
    .plan-group {
      background-color: var(--bg-card);
      border: none;
      padding: 20px;
      border-radius: var(--radius-lg); /* 大圓角 */
      box-shadow: var(--shadow-md); /* 柔和陰影 */
      margin-bottom: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .plan-group:hover {
        /*box-shadow: var(--shadow-lg);*/
    }
    
    /* 設定區塊 (底下那個 Google Calendar 設定) */
    #gc-title-setting {
        background-color: var(--bg-card) !important;
        border-radius: var(--radius-lg) !important;
        border: none !important;
        box-shadow: var(--shadow-md);
        padding: 20px !important;
    }

    .plan-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 0 15px 0; 
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 15px;
    }
    .plan-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
    }
    .plan-header .toggle-icon {
        font-size: 14px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--bg-input);
        color: var(--text-main);
    }

    /* 輸入框樣式優化 - 參考圖的 "Fill Out Vision" 樣式 */
    label {
      margin: 12px 0 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      display: block;
    }
    
    input[type="text"], input[type="number"], input[type="date"], textarea {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      font-size: 14px;
      background-color: var(--bg-input); /* 淺灰背景 */
      color: var(--text-main);
      box-sizing: border-box;
      transition: all 0.2s;
    }
    input:focus, textarea:focus {
        outline: none;
        background-color: var(--bg-card);
        border-color: var(--border-focus);
        box-shadow: 0 0 0 2px rgba(0,0,0,0.05);
    }
    
    /* 側邊欄主要操作按鈕 */
    .sidebar-actions {
        display: flex; 
        gap: 10px;
        flex-wrap: wrap;
    }
    .sidebar button {
      background-color: var(--bg-card);
      color: var(--text-main);
      border: 1px solid var(--border-color);
      cursor: pointer;
      width: 100%;
      justify-content: center;
      padding: 12px;
      border-radius: var(--radius-pill); /* 藥丸形 */
      font-weight: 600;
      box-shadow: var(--shadow-sm);
      margin-bottom: 10px;
    }
    
    /* "新增計劃" & "產生" 按鈕 - 黑色強調色 */
    .sidebar-actions button {
        background-color: var(--accent-black);
        color: var(--bg-card); /* 反轉色 */
        border: none;
    }
    .dark-mode .sidebar-actions button {
        color: #000; /* Dark mode 下按鈕文字為黑 */
    }
    .sidebar-actions button:hover {
        background-color: var(--accent-hover);
    }

    /* 刪除按鈕 - 小圓形 Icon */
    .delete-btn {
      width: 30px;
      height: 30px;
      border-radius: 50% !important;
      padding: 0 !important;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--bg-input) !important;
      color: var(--text-main) !important;
      border: none !important;
      margin: 0 !important;
      font-size: 12px;
    }
    .delete-btn:hover {
        background-color: #ffebee !important;
        color: #d32f2f !important;
    }

    .color-label { 
        display: flex;
        align-items: center;
    }
    .color-label input[type="color"] {
         -webkit-appearance: none;
        position:relative;
        margin:5px;
        width: 25px;
        height: 25px;
        border-radius: 100px;
        border:0.5px solid gray;
        box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
    }
    input[type="color"]::-webkit-color-swatch {
        position:absolute;
        top:-1px;
        left:-1px;
        right:-1px;
        bottom:-1px;
        box-sizing: border-box;
        border:1px solid transparent;
    }
    .color-label button {
        width: auto; padding: 5px 12px; margin: 0; font-size: 12px;
    }

    /* Checkbox & Radio 優化 */
    input[type="checkbox"], input[type="radio"] {
        accent-color: var(--text-main);
        width: 16px; height: 16px; cursor: pointer;
    }
    .weekday-checkboxes {
        display: flex; justify-content: space-between;
        background: var(--bg-input);
        padding: 5px; border-radius: var(--radius-md);
    }
    .weekday-checkboxes label {
        margin: 0; padding: 5px; 
        display: flex; flex-direction: column; align-items: center;
        font-size: 10px; cursor: pointer; color: var(--text-main);
    }

    /* --- 日曆樣式優化 (Card Style) --- */

    #calendar {
      display: flex; 
      flex-direction: column;
      gap: 30px; 
    }
    
    /* 月份容器 - 卡片化 */
    .month-container {
        background-color: var(--bg-card);
        border-radius: var(--radius-lg);
        border: none; /* 移除邊框 */
        box-shadow: var(--shadow-md); /* 增加陰影 */
        overflow: hidden;
    }

    /* Month Header */
    .month-header {
        font-size: 20px;
        font-weight: 700;
        padding: 20px 25px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-main);
        background: var(--bg-card);
    }
    .month-header .toggle-icon {
        color: var(--text-secondary);
        font-size: 16px;
    }
    
    /* Calendar Grid */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0;
        border: none;
        background: var(--bg-card);
    }

    .weekday-header {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 12px;
      text-align: center;
      padding: 15px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border-color);
    }
    .weekday-weekend {
        color: var(--highlight-color) !important;
    }

    /* Day Cell */
    .day {
      border: none;
      /*border-right: 1px solid var(--calendar-grid-line);*/
      /*border-bottom: 1px solid var(--calendar-grid-line);*/
      background-color: var(--bg-card);
      padding: 10px 15px;
      min-height: 120px; /* 增加高度 */
      position: relative;
      transition: background-color 0.2s;
    }
    /* 增加網格線 (用偽元素或 shadow 模擬更乾淨) */
    .day {
        box-shadow: inset -1px -1px 0 var(--calendar-grid-line);
    }
    
    .day:hover {
        background-color: rgba(0,0,0,0.01);
    }
    .dark-mode .day:hover {
        background-color: rgba(255,255,255,0.02);
    }

    /* 週末背景微調 */
    .calendar-grid > .day:nth-child(7n), 
    .calendar-grid > .day:nth-child(7n+1) {
       /* background-color: rgba(0,0,0,0.005); */
    }

    /* Today Highlight */
    .day.today {
        border: none !important;
        box-shadow: inset 0 0 0 2px var(--highlight-color), inset -1px -1px 0 var(--calendar-grid-line);
    }
    
    .empty-day {
        background-color: transparent;
        box-shadow: inset -1px -1px 0 var(--calendar-grid-line);
    }
    
    /* Date Number - Big & Bold */
    .date-only {
      font-weight: 700;
      font-size: 24px;
      color: var(--text-main);
      opacity: 0.8;
      margin-bottom: 8px;
    }
    
    /* Task Item - Pill Style */
    .task {
      padding: 4px 10px;
      margin-top: 5px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      border-left: 3px solid rgba(0,0,0,0.1); /* 增加一個左側強調線 */
    }

    /* RWD */
    @media (max-width: 768px) {
      .app-container { flex-direction: column; }
      .nav-sidebar { display: none; }
      .main-content { padding: 20px; }
      .container { flex-direction: column; }
      .sidebar { max-width: 100%; }
      .header-main { flex-direction: column; align-items: flex-start; gap: 15px; }
      .header-title-area { width: 100%; justify-content: space-between; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="main-content">
      
      <div class="header-main">
          <div class="header-title-area">
              <div class="svg_icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,14a1,1,0,1,0-1-1A1,1,0,0,0,12,14Zm5,0a1,1,0,1,0-1-1A1,1,0,0,0,17,14Zm-5,4a1,1,0,1,0-1-1A1,1,0,0,0,12,18Zm5,0a1,1,0,1,0-1-1A1,1,0,0,0,17,18ZM7,14a1,1,0,1,0-1-1A1,1,0,0,0,7,14ZM19,4H18V3a1,1,0,0,0-2,0V4H8V3A1,1,0,0,0,6,3V4H5A3,3,0,0,0,2,7V19a3,3,0,0,0,3,3H19a3,3,0,0,0,3-3V7A3,3,0,0,0,19,4Zm1,15a1,1,0,0,1-1,1H5a1,1,0,0,1-1-1V10H20ZM20,8H4V7A1,1,0,0,1,5,6H19a1,1,0,0,1,1,1ZM7,18a1,1,0,1,0-1-1A1,1,0,0,0,7,18Z"/></svg>
              </div>
              <div>
                <h1 data-i18n="mainHeader">學習計劃表</h1>
                <p data-i18n-id="headerSubtitle">Visual Learning Planner</p>
              </div>
          </div>
          <div class="calendar-controls">
              <div class="header_btn">
                  <button onclick="toggleLanguage()" id="lang-toggle-btn">
                      <i class="fa-solid fa-language"></i>
                      <span data-i18n="toggleLangBtn">中/En</span>
                  </button>
                  <button onclick="toggleTheme()" id="theme-toggle-btn">
                      <i id="theme-icon" class="fa-solid fa-moon"></i>
                      <span data-i18n-id="toggleThemeBtn">夜間</span>
                  </button>
              </div>
          </div>
      </div>
      
      <div class="container">
        
        <div class="sidebar">
          <div class="sidebar-actions"> 
             <button onclick="addPlan()" data-i18n="addPlanBtn"><i class="fa-solid fa-plus"></i> 新增學習計劃</button>
             <button onclick="generatePlan()" data-i18n="generatePlanBtn"> <i class="fa-solid fa-bolt"></i> &nbsp產生記憶計劃</button>
          </div>

          <div id="plan-container">
            </div>
          
          <div id="gc-title-setting" class="plan-group"> 
            <label style="font-weight: bold; margin-bottom: 8px;" data-i18n-id="gcTitleSettingLabel">Google Caledar 設定:</label>
            <div style="margin-bottom: 5px;">
              <input type="radio" id="mergePlans" name="gcTitleOption" value="merge" checked>
              <label for="mergePlans" style="display: inline; font-weight: 500;" data-i18n-id="mergePlansLabel">合併顯示 (Merge)</label>
            </div>
            <div>
              <input type="radio" id="separatePlans" name="gcTitleOption" value="separate">
              <label for="separatePlans" style="display: inline; font-weight: 500;" data-i18n-id="separatePlansLabel">獨立顯示 (Separate)</label>
            </div>
            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 15px 0;">
            <button onclick="addToGoogleCalendar()" id="addToCalendarBtn" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-main);">
                <i class="fa-brands fa-google"></i> <span data-i18n-id="addToCalendarBtnText">加入行事曆</span>
            </button>
            <button onclick="downloadCSV()" data-i18n="downloadCSVBtn" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-main);">
                <i class="fa-solid fa-file-csv"></i> 下載 CSV
            </button>
          </div>
        </div>
        
        <div class="main">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
              <label style="display: flex; align-items: center; width: auto; cursor: pointer;">
                <input type="checkbox" id="selectAllDays" onchange="toggleAllCheckboxes()" style="width: auto; margin: 0 8px 0 0;">
                <span data-i18n-id="selectAllDays">全選日期</span>
              </label>
          </div>

          <div id="calendar"></div>
        </div>
      </div>
    </div> </div> 
    
    <script>
    const weekdayMap = ['日', '一', '二', '三', '四', '五', '六'];
    const weekdayMap_en = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    // 使用更柔和的莫蘭迪色系/Pastel Colors
    const defaultColors = ['#E3F2FD', '#F3E5F5', '#E8F5E9', '#FFF3E0', '#FBE9E7', '#E0F2F1'];
    let latestPlan = {};
    let allPlansData = {}; 
    let planCount = 0;
    let planColors = {}; 
    let currentLang = 'zh'; 

    // 國際化文本
    const translations = {
      zh: {
        pageTitle: '學習計劃表產生器',
        mainHeader: '學習計劃表產生器',
        headerSubtitle: 'Visual Learning Planner',
        toggleThemeBtn: '夜間', 
        toggleLangBtn: '中/En',
        addPlanBtn: '新增計劃',
        generatePlanBtn: '產生計劃',
        downloadCSVBtn: '下載 CSV',
        selectAllDays: '全選日期', 
        addToCalendarBtnText: '加入 Google 行事曆', 
        gcTitleSettingLabel: 'Google Caledar 顯示設定:', 
        mergePlansLabel: '合併顯示多個計劃',
        separatePlansLabel: '將計劃各自獨立顯示',
        planHeader: '任務', 
        titleLabel: '計劃名稱：',
        colorLabel: '標籤顏色',
        randomColorBtn: '隨機',
        unitLabel: '任務名稱/單位',
        startDateLabel: '開始日',
        endDateLabel: '結束日 (選填)',
        executionDatesLabel: '指定特定執行日期', 
        executionDatesPlaceholder: '用逗號或換行分隔 M/D 或 YYYY/M/D',
        excludeDaysLabel: '排除星期',
        weekdaySun: '日', weekdayMon: '一', weekdayTue: '二', weekdayWed: '三', weekdayThu: '四', weekdayFri: '五', weekdaySat: '六',
        excludeDatesLabel: '指定排除日',
        excludeDatesPlaceholder: '用逗號或換行分隔 M/D 或 YYYY/M/D',
        rangeLabel: '任務範圍',
        rangeTypePages: '頁數',
        rangeTypeOutline: '大綱',
        pageRangeLabel: '頁數範圍 (ex. 19~306)',
        outlineLabel: '任務清單/大綱',
        outlinePlaceholder: '主題一,主題二,主題三',
        dailyAmountLabel: '每日執行量',
        requiredDaysLabel: '預估天數', 
        reverseOrder: '逆序',
        showContentLabel: '執行動作',
        showStudy: '學習',
        showReview: '複習',
        showCustom: '自訂', 
        customTextLabel: '自訂文字', 
        customTextPlaceholder: '例如：Task', 
        deleteBtn: '刪除',
        studyText: '學習',
        reviewText: '複習',
      },
      en: {
        pageTitle: 'Ebbinghaus Memory Plan',
        mainHeader: 'Ebbinghaus Memory Plan',
        headerSubtitle: 'Visual Learning Planner',
        toggleThemeBtn: 'Dark', 
        toggleLangBtn: 'Zh/En',
        addPlanBtn: 'Add Plan',
        generatePlanBtn: 'Generate',
        downloadCSVBtn: 'Download CSV',
        selectAllDays: 'Select All', 
        addToCalendarBtnText: 'Google Calendar', 
        gcTitleSettingLabel: 'Calendar Title Setting:',
        mergePlansLabel: 'Merge Plans',
        separatePlansLabel: 'Separate Plans',
        planHeader: 'Plan', 
        titleLabel: 'Plan Name:',
        colorLabel: 'Color Tag',
        randomColorBtn: 'Reset',
        unitLabel: 'Task Name/Unit',
        startDateLabel: 'Start Date',
        endDateLabel: 'End Date (Optional)',
        executionDatesLabel: 'Specific Dates', 
        executionDatesPlaceholder: 'e.g. 11/23\n11/25',
        excludeDaysLabel: 'Exclude Days',
        weekdaySun: 'S', weekdayMon: 'M', weekdayTue: 'T', weekdayWed: 'W', weekdayThu: 'T', weekdayFri: 'F', weekdaySat: 'S',
        excludeDatesLabel: 'Exclude Dates',
        excludeDatesPlaceholder: 'e.g. 7/22\n12/25',
        rangeLabel: 'Scope',
        rangeTypePages: 'Pages',
        rangeTypeOutline: 'Outline',
        pageRangeLabel: 'Range (e.g. 19~306)',
        outlineLabel: 'Outline (comma separated)',
        outlinePlaceholder: 'Topic 1, Topic 2',
        dailyAmountLabel: 'Daily Amount',
        requiredDaysLabel: 'Est. Days', 
        reverseOrder: 'Reverse',
        showContentLabel: 'Actions',
        showStudy: 'Study',
        showReview: 'Review',
        showCustom: 'Custom',
        customTextLabel: 'Custom Text',
        customTextPlaceholder: 'e.g. Task',
        deleteBtn: 'Delete',
        studyText: 'Study',
        reviewText: 'Review',
      }
    };

    function getRandomColor() {
      return defaultColors[Math.floor(Math.random() * defaultColors.length)];
    }

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }
    function getDateStr(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function parseDateInputToYYYYMMDD(dateStr, referenceYear) {
        dateStr = dateStr.trim();
        const parts = dateStr.split(/[\/-]/).filter(Boolean).map(s => s.trim());
        let y, m, d;
        if (parts.length === 2) { 
            m = parseInt(parts[0], 10);
            d = parseInt(parts[1], 10);
            y = referenceYear;
        } else if (parts.length === 3) { 
            if (parts[0].length === 4) {
                y = parseInt(parts[0], 10);
                m = parseInt(parts[1], 10);
                d = parseInt(parts[2], 10);
            } else if (parts[2].length === 4) { 
                y = parseInt(parts[2], 10);
                m = parseInt(parts[0], 10);
                d = parseInt(parts[1], 10);
            } else { return null; }
        } else { return null; }
        if (isNaN(y) || isNaN(m) || isNaN(d) || m < 1 || m > 12 || d < 1 || d > 31) return null;
        const date = new Date(y, m - 1, d);
        if (date.getFullYear() !== y || date.getMonth() !== m - 1 || date.getDate() !== d) return null;
        return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    }

    function isExcluded(date, excludeWeekdays, excludeDates) {
        const dayOfWeek = date.getDay();
        const dateStr = getDateStr(date);
        return excludeWeekdays.includes(dayOfWeek) || excludeDates.includes(dateStr);
    }
    
    function getRangeString(items) {
        if (!items || items.length === 0) return '';
        const isNumeric = items.every(item => /^\d+$/.test(item));
        if (isNumeric) {
            const numbers = items.map(Number).sort((a, b) => a - b);
            const start = numbers[0];
            const end = numbers[numbers.length - 1];
            let isConsecutive = true;
            for (let i = 0; i < numbers.length - 1; i++) {
                if (numbers[i] + 1 !== numbers[i + 1]) {
                    isConsecutive = false;
                    break;
                }
            }
            if (start === end) return String(start);
            else if (isConsecutive) return `${start}~${end}`;
            else return items.join(', ');
        } else {
            return items.join(', ');
        }
    }
    
    function updateRequiredDays(id) {
        const dailyAmountInput = document.getElementById(`dailyAmount-${id}`);
        const requiredDaysSpan = document.getElementById(`requiredDays-${id}`);
        if (!dailyAmountInput || !requiredDaysSpan) return;
        const totalRange = getTaskRange(id);
        const dailyAmount = parseInt(dailyAmountInput.value);
        let requiredDays = '-';
        if (totalRange > 0 && dailyAmount > 0 && !isNaN(dailyAmount)) {
            requiredDays = Math.ceil(totalRange / dailyAmount);
            requiredDays = requiredDays + (currentLang === 'zh' ? ' 天' : ' Days');
        }
        requiredDaysSpan.textContent = requiredDays;
    }
    
    function getTaskRange(id) {
        const items = getItemsArray(id);
        return items.length;
    }

    function getItemsArray(id) {
        let items = [];
        const rangeType = document.querySelector(`input[name="rangeType-${id}"]:checked`)?.value || 'pages';
        const reverse = document.getElementById(`reverseOrder-${id}`)?.checked || false;
        if (rangeType === 'pages') {
            const pageRangeInput = document.getElementById(`pageRange-${id}`);
            if (!pageRangeInput) return [];
            const rangeStr = pageRangeInput.value.trim();
            const match = rangeStr.match(/^(\d+)~(\d+)$/);
            if (match) {
                let start = parseInt(match[1]);
                let end = parseInt(match[2]);
                if (start > end) [start, end] = [end, start];
                for (let i = start; i <= end; i++) items.push(String(i));
            } else if (/^\d+$/.test(rangeStr)) {
                 items.push(rangeStr);
            }
        } else if (rangeType === 'outline') {
            const outlineInput = document.getElementById(`outline-${id}`);
            if (!outlineInput) return [];
            const outlineStr = outlineInput.value.trim();
            items = outlineStr.split(',').map(item => item.trim()).filter(item => item.length > 0);
        }
        return reverse ? items.reverse() : items;
    }

    function loadPlansData() {
        try {
            const savedPlans = localStorage.getItem('learningPlans');
            if (savedPlans) {
                allPlansData = JSON.parse(savedPlans);
                const ids = Object.keys(allPlansData).map(Number);
                if (ids.length > 0) planCount = Math.max(...ids) + 1;
                Object.values(allPlansData).forEach(planData => {
                    if (planData.color) planColors[planData.id] = planData.color;
                });
            } else {
                allPlansData = {};
                planCount = 0;
            }
        } catch (e) {
            allPlansData = {};
            planCount = 0;
        }
    }

    function savePlanData(id) {
        const planGroup = document.querySelector(`.plan-group[data-id="${id}"]`);
        if (!planGroup) return;

        const colorPicker = document.getElementById(`colorPicker-${id}`);
        const unitInput = document.getElementById(`unit-${id}`);
        const startDateInput = document.getElementById(`startDate-${id}`);
        const endDateInput = document.getElementById(`endDate-${id}`);
        const executionDatesInput = document.getElementById(`executionDates-${id}`);
        const useExecutionDatesCheckbox = document.getElementById(`useExecutionDatesCheckbox-${id}`);
        const excludeDatesInput = document.getElementById(`excludeDates-${id}`);
        const excludeCustomDatesCheckbox = document.getElementById(`excludeCustomDates-${id}`);
        const dailyAmountInput = document.getElementById(`dailyAmount-${id}`);
        const pageRangeInput = document.getElementById(`pageRange-${id}`);
        const outlineInput = document.getElementById(`outline-${id}`);
        const reverseOrderCheckbox = document.getElementById(`reverseOrder-${id}`);
        const showStudyCheckbox = document.getElementById(`showStudy-${id}`);
        const showReviewCheckbox = document.getElementById(`showReview-${id}`);
        const showCustomCheckbox = document.getElementById(`showCustomCheckbox-${id}`);
        const customTextInput = document.getElementById(`customText-${id}`);
        
        const rangeType = document.querySelector(`input[name="rangeType-${id}"]:checked`)?.value || 'pages';

        let excludeWeekdays = [];
        for (let i = 0; i < 7; i++) {
            if (document.getElementById(`excludeWeekday-${id}-${i}`)?.checked) excludeWeekdays.push(i);
        }

        const planData = {
            id: id,
            color: colorPicker ? colorPicker.value : '',
            unit: unitInput ? unitInput.value.trim() : '',
            startDate: startDateInput ? startDateInput.value : '',
            endDate: endDateInput ? endDateInput.value : '',
            executionDates: executionDatesInput ? executionDatesInput.value.trim() : '',
            useExecutionDates: useExecutionDatesCheckbox ? useExecutionDatesCheckbox.checked : false,
            excludeWeekdays: excludeWeekdays,
            excludeDates: excludeDatesInput ? excludeDatesInput.value.trim() : '',
            useExcludeDates: excludeCustomDatesCheckbox ? excludeCustomDatesCheckbox.checked : false,
            rangeType: rangeType,
            dailyAmount: dailyAmountInput ? parseInt(dailyAmountInput.value) : 1,
            pageRange: pageRangeInput ? pageRangeInput.value.trim() : '',
            outline: outlineInput ? outlineInput.value.trim() : '',
            reverseOrder: reverseOrderCheckbox ? reverseOrderCheckbox.checked : false,
            showStudy: showStudyCheckbox ? showStudyCheckbox.checked : true,
            showReview: showReviewCheckbox ? showReviewCheckbox.checked : true,
            showCustom: showCustomCheckbox ? showCustomCheckbox.checked : false,
            customText: customTextInput ? customTextInput.value.trim() : '',
        };

        allPlansData[id] = planData;
        localStorage.setItem('learningPlans', JSON.stringify(allPlansData));
    }

    function deletePlan(id) {
        if (!confirm(currentLang === 'zh' ? '確定要刪除這個計劃嗎？' : 'Are you sure you want to delete this plan?')) {
            return;
        }
        const planGroup = document.querySelector(`.plan-group[data-id="${id}"]`);
        if (planGroup) planGroup.remove();
        delete allPlansData[id];
        delete planColors[id];
        localStorage.setItem('learningPlans', JSON.stringify(allPlansData));
        generatePlan();
    }

    function renderPlans() {
        const container = document.getElementById('plan-container');
        if (!container) return;
        container.innerHTML = '';
        Object.values(allPlansData).forEach(planData => {
            addPlan(planData, planData.id);
        });
    }

    function addPlan(planData = null, id = null) {
        const headerText = translations[currentLang].planHeader;
        id = id === null ? planCount++ : id;
        
        let colorValue;
        if (planColors[id]) colorValue = planColors[id];
        else if (planData && planData.color) colorValue = planData.color;
        else colorValue = getRandomColor();
        planColors[id] = colorValue; 

        const showStudy = planData === null || planData.showStudy === undefined ? true : planData.showStudy;
        const showReview = planData === null || planData.showReview === undefined ? true : planData.showReview;
        const showCustom = planData ? planData.showCustom : false;
        const customText = planData ? planData.customText : '';
        const isExecutionDatesUsed = planData ? planData.useExecutionDates : false;
        const isExcludeDatesCustomChecked = planData ? planData.useExcludeDates : false;
        const rangeType = planData ? planData.rangeType : 'pages';
        const container = document.getElementById('plan-container');
        
        const newPlanGroup = document.createElement('div');
        newPlanGroup.className = 'plan-group';
        newPlanGroup.dataset.id = id;
        
        // 側邊欄卡片不隨顏色改變背景，僅改變 border 或標籤，保持整潔白底
        // 但我們可以用左側邊框來標示顏色
        newPlanGroup.style.borderLeft = `5px solid ${colorValue}`;

        newPlanGroup.innerHTML = `
            <div class="plan-header" onclick="togglePlanContent(${id})">
                <h3 id="plan-title-${id}" data-i18n="planHeader">${headerText} #${id}</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="toggle-icon" data-id="${id}">▲</span>
                    <button class="delete-btn" onclick="event.stopPropagation(); deletePlan(${id})" title="${translations[currentLang].deleteBtn}"><i class="fa-solid fa-trash"></i></button>

                </div>
            </div>
            <div id="plan-content-${id}" class="plan-content" onchange="savePlanData(${id})">
                
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 12px;">
                    <label data-i18n-id="unitLabel" style="flex:1; margin-right:10px;"><span>${translations[currentLang].unitLabel}</span>
                        <input id="unit-${id}" type="text" placeholder="" value="${planData ? planData.unit : ''}">
                    </label>
                </div>

                <div class="color-label" style="margin-bottom:12px;">
                    <label data-i18n-id="colorLabel" style="margin:0;"><span>${translations[currentLang].colorLabel}</span></label>
                    <div style="display:flex; align-items:center;">
                        <input id="colorPicker-${id}" class="color_picker" type="color" value="${colorValue}">
                        <button onclick="randomizeColor(${id})" data-i18n-id="randomColorBtn">${translations[currentLang].randomColorBtn}</button>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <label style="flex:1;"><span data-i18n-id="startDateLabel">${translations[currentLang].startDateLabel}</span><input id="startDate-${id}" type="date" value="${planData ? planData.startDate : formatDate(new Date())}"></label>
                    <label style="flex:1;"><span data-i18n-id="endDateLabel">${translations[currentLang].endDateLabel}</span><input id="endDate-${id}" type="date" value="${planData ? planData.endDate : ''}"></label>
                </div>

                <label style="display: flex; align-items: center; margin-bottom: 5px; cursor: pointer;">
                    <input id="useExecutionDatesCheckbox-${id}" type="checkbox" ${isExecutionDatesUsed ? 'checked' : ''} onchange="toggleExecutionDatesInput(${id})" style="width: auto; margin: 0 5px 0 0;">
                    <span data-i18n-id="executionDatesLabel">${translations[currentLang].executionDatesLabel}</span>
                </label>
                
                <div id="executionDatesDiv-${id}" style="display: ${isExecutionDatesUsed ? 'block' : 'none'};">
                    <textarea id="executionDates-${id}" data-i18n-placeholder="executionDatesPlaceholder" placeholder="${translations[currentLang].executionDatesPlaceholder}">${planData ? planData.executionDates : ''}</textarea>
                </div>
                
                <label data-i18n-id="excludeDaysLabel" style="margin-top: 15px;">${translations[currentLang].excludeDaysLabel}</label>
                <div class="weekday-checkboxes">
                    <label><input id="excludeWeekday-${id}-0" type="checkbox" ${planData && planData.excludeWeekdays.includes(0) ? 'checked' : ''}><span data-i18n-id="weekdaySun">${translations[currentLang].weekdaySun}</span></label>
                    <label><input id="excludeWeekday-${id}-1" type="checkbox" ${planData && planData.excludeWeekdays.includes(1) ? 'checked' : ''}><span data-i18n-id="weekdayMon">${translations[currentLang].weekdayMon}</span></label>
                    <label><input id="excludeWeekday-${id}-2" type="checkbox" ${planData && planData.excludeWeekdays.includes(2) ? 'checked' : ''}><span data-i18n-id="weekdayTue">${translations[currentLang].weekdayTue}</span></label>
                    <label><input id="excludeWeekday-${id}-3" type="checkbox" ${planData && planData.excludeWeekdays.includes(3) ? 'checked' : ''}><span data-i18n-id="weekdayWed">${translations[currentLang].weekdayWed}</span></label>
                    <label><input id="excludeWeekday-${id}-4" type="checkbox" ${planData && planData.excludeWeekdays.includes(4) ? 'checked' : ''}><span data-i18n-id="weekdayThu">${translations[currentLang].weekdayThu}</span></label>
                    <label><input id="excludeWeekday-${id}-5" type="checkbox" ${planData && planData.excludeWeekdays.includes(5) ? 'checked' : ''}><span data-i18n-id="weekdayFri">${translations[currentLang].weekdayFri}</span></label>
                    <label><input id="excludeWeekday-${id}-6" type="checkbox" ${planData && planData.excludeWeekdays.includes(6) ? 'checked' : ''}><span data-i18n-id="weekdaySat">${translations[currentLang].weekdaySat}</span></label>
                </div>
                
                <label style="display: flex; align-items: center; margin-top: 15px; margin-bottom: 5px; cursor: pointer;">
                    <input id="excludeCustomDates-${id}" type="checkbox" ${isExcludeDatesCustomChecked ? 'checked' : ''} onchange="toggleExcludeDatesInput(${id})" style="width: auto; margin: 0 5px 0 0;">
                    <span data-i18n-id="excludeDatesLabel">${translations[currentLang].excludeDatesLabel}</span>
                </label>
                <div id="excludeDatesDiv-${id}" style="display: ${isExcludeDatesCustomChecked ? 'block' : 'none'};">
                    <textarea id="excludeDates-${id}" data-i18n-placeholder="excludeDatesPlaceholder" placeholder="${translations[currentLang].excludeDatesPlaceholder}">${planData ? planData.excludeDates : ''}</textarea>
                </div>

                <div style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                    <label data-i18n-id="rangeLabel" style="margin-bottom: 5px;">${translations[currentLang].rangeLabel}</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px;">
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input type="radio" name="rangeType-${id}" value="pages" ${rangeType === 'pages' ? 'checked' : ''} onchange="toggleRangeType(${id})"><span data-i18n-id="rangeTypePages">${translations[currentLang].rangeTypePages}</span></label>
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input type="radio" name="rangeType-${id}" value="outline" ${rangeType === 'outline' ? 'checked' : ''} onchange="toggleRangeType(${id})"><span data-i18n-id="rangeTypeOutline">${translations[currentLang].rangeTypeOutline}</span></label>
                    </div>

                    <div id="pageRangeDiv-${id}" style="display: ${rangeType === 'pages' ? 'block' : 'none'};">
                        <label data-i18n-id="pageRangeLabel"><span>${translations[currentLang].pageRangeLabel}</span>
                            <input id="pageRange-${id}" type="text" placeholder="ex. 19~306" value="${planData ? planData.pageRange : ''}" oninput="updateRequiredDays(${id})">
                        </label>
                    </div>

                    <div id="outlineDiv-${id}" style="display: ${rangeType === 'outline' ? 'block' : 'none'};">
                        <label data-i18n-id="outlineLabel"><span>${translations[currentLang].outlineLabel}</span>
                            <textarea id="outline-${id}" data-i18n-placeholder="outlinePlaceholder" placeholder="${translations[currentLang].outlinePlaceholder}" oninput="updateRequiredDays(${id})">${planData ? planData.outline : ''}</textarea>
                        </label>
                    </div>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <label data-i18n-id="dailyAmountLabel" style="flex:1;"><span>${translations[currentLang].dailyAmountLabel}</span>
                        <input id="dailyAmount-${id}" type="number" min="1" value="${planData ? planData.dailyAmount : 1}" oninput="updateRequiredDays(${id})">
                    </label>

                    <label data-i18n-id="requiredDaysLabel" style="flex:1;"><span>${translations[currentLang].requiredDaysLabel}</span>
                        <div style="padding: 12px; background: var(--bg-input); border-radius: var(--radius-md); text-align:center;">
                            <span id="requiredDays-${id}" style="font-weight: bold;">-</span>
                        </div>
                    </label>
                </div>

                <label style="display: flex; align-items: center; margin-top: 5px; cursor: pointer;">
                    <input id="reverseOrder-${id}" type="checkbox" ${planData && planData.reverseOrder ? 'checked' : ''} style="width: auto; margin: 0 5px 0 0;">
                    <span>${translations[currentLang].reverseOrder}</span>
                </label>

                <div style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                    <label data-i18n-id="showContentLabel" style="margin-bottom: 5px;">${translations[currentLang].showContentLabel}</label>
                    <div class="action-checkboxes" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px;">
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input id="showStudy-${id}" type="checkbox" ${showStudy ? 'checked' : ''}><span data-i18n-id="showStudy"> ${translations[currentLang].showStudy}</span></label>
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input id="showReview-${id}" type="checkbox" ${showReview ? 'checked' : ''}><span data-i18n-id="showReview"> ${translations[currentLang].showReview}</span></label>
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input id="showCustomCheckbox-${id}" type="checkbox" ${showCustom ? 'checked' : ''} onchange="toggleCustomText(${id})"><span data-i18n-id="showCustom"> ${translations[currentLang].showCustom}</span></label>
                    </div>
                    <div id="customTextDiv-${id}" style="display: ${showCustom ? 'block' : 'none'};">
                        <label data-i18n-id="customTextLabel"><span>${translations[currentLang].customTextLabel}</span>
                            <input id="customText-${id}" type="text" data-i18n-placeholder="customTextPlaceholder" placeholder="${translations[currentLang].customTextPlaceholder}" value="${customText}">
                        </label>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newPlanGroup);

        updatePlanTitle(id);
        updateRequiredDays(id);

        document.getElementById(`colorPicker-${id}`).addEventListener('input', (e) => {
            const group = document.querySelector(`.plan-group[data-id="${id}"]`);
            group.style.borderLeft = `5px solid ${e.target.value}`;
            planColors[id] = e.target.value; 
            savePlanData(id);
        });

        if (planData && planData.isCollapsed) {
            const content = document.getElementById(`plan-content-${id}`);
            const icon = document.querySelector(`.plan-header .toggle-icon[data-id="${id}"]`);
            if (content && icon) {
                 content.classList.add('collapsed');
                 content.style.maxHeight = '0';
                 content.style.paddingTop = '0';
                 content.style.paddingBottom = '0';
                 content.style.overflow = 'hidden';
                 icon.textContent = '▼';
            }
        }
    }

    function togglePlanContent(id) {
        const content = document.getElementById(`plan-content-${id}`);
        const icon = document.querySelector(`.plan-header .toggle-icon[data-id="${id}"]`);
        if (content && icon) {
            const isCollapsed = content.classList.toggle('collapsed');
            if (isCollapsed) {
                 content.style.maxHeight = '0';
                 content.style.paddingTop = '0';
                 content.style.paddingBottom = '0';
                 content.style.overflow = 'hidden';
                 icon.textContent = '▼';
            } else {
                 content.style.maxHeight = '2000px'; 
                 content.style.paddingTop = '10px';
                 content.style.paddingBottom = '10px';
                 content.style.overflow = 'visible';
                 icon.textContent = '▲';
            }
            allPlansData[id].isCollapsed = isCollapsed;
            localStorage.setItem('learningPlans', JSON.stringify(allPlansData));
        }
    }
    
    function toggleRangeType(id) {
        const pagesDiv = document.getElementById(`pageRangeDiv-${id}`);
        const outlineDiv = document.getElementById(`outlineDiv-${id}`);
        const rangeType = document.querySelector(`input[name="rangeType-${id}"]:checked`)?.value;

        if (pagesDiv && outlineDiv) {
            pagesDiv.style.display = rangeType === 'pages' ? 'block' : 'none';
            outlineDiv.style.display = rangeType === 'outline' ? 'block' : 'none';
        }
        updateRequiredDays(id);
        savePlanData(id);
    }
    
    function generatePlan() {
        const planData = {}; 
        const allPlans = Object.values(allPlansData);
        let earliestDate = null;
        let latestDate = null;

        allPlans.forEach(plan => {
            const id = plan.id;
            const startDateValue = plan.startDate;
            const endDateValue = plan.endDate;
            const dailyAmount = plan.dailyAmount;
            const items = getItemsArray(id);
            const itemsCount = items.length;

            if (!startDateValue || itemsCount === 0) return;

            const unitContent = plan.unit || '';
            const unitString = unitContent ? ` ${unitContent}` : ''; 
            const showStudy = plan.showStudy;
            const showReview = plan.showReview;
            const showCustom = plan.showCustom;
            const customText = plan.customText;
            const studyText = translations[currentLang].studyText;
            const reviewText = translations[currentLang].reviewText;
            let studyPrefix = studyText;
            let reviewPrefix = reviewText;
            if (showCustom && customText) {
                studyPrefix = customText;
                reviewPrefix = customText;
            }
            const shouldGeneratePrimaryTask = showStudy || (showCustom && customText.length > 0);
            let excludeWeekdays = plan.excludeWeekdays;
            let excludeDates = [];
            if (plan.useExcludeDates) {
                const datesStr = plan.excludeDates || '';
                const referenceYear = new Date(startDateValue).getFullYear();
                datesStr.split(/[\n,]/).forEach(dateStr => {
                    const yyyymmdd = parseDateInputToYYYYMMDD(dateStr, referenceYear);
                    if (yyyymmdd) excludeDates.push(yyyymmdd);
                });
            }
            let executionDates = [];
            if (plan.useExecutionDates) {
                const datesStr = plan.executionDates || '';
                const referenceYear = new Date(startDateValue).getFullYear();
                datesStr.split(/[\n,]/).forEach(dateStr => {
                    const yyyymmdd = parseDateInputToYYYYMMDD(dateStr, referenceYear);
                    if (yyyymmdd) executionDates.push(yyyymmdd);
                });
                executionDates = [...new Set(executionDates)].sort(); 
            }

            const color = plan.color;
            let itemIndex = 0;
            let currentDate = new Date(startDateValue);
            let limitDate = endDateValue ? new Date(endDateValue) : null;
            
            if (plan.useExecutionDates && executionDates.length > 0) {
                executionDates.forEach(dateStr => {
                    if (itemIndex >= itemsCount) return; 
                    const date = new Date(dateStr);
                    if (!isExcluded(date, excludeWeekdays, excludeDates)) {
                        const dateKey = getDateStr(date);
                        if (!planData[dateKey]) planData[dateKey] = [];
                        const studiedItems = [];
                        for (let i = 0; i < dailyAmount && itemIndex < itemsCount; i++) {
                            studiedItems.push(items[itemIndex++]);
                        }
                        if (studiedItems.length > 0 && shouldGeneratePrimaryTask) {
                             const rangeString = getRangeString(studiedItems);
                             const studyTask = {
                                 planId: id,
                                 text: `${studyPrefix}: ${rangeString}${unitString}`,
                                 color: color,
                                 isStudy: true,
                                 item: rangeString,
                                 unit: unitContent,
                             };
                             planData[dateKey].push(studyTask);
                        }
                        scheduleReviews(date, studiedItems, planData, id, reviewPrefix, showReview, excludeWeekdays, excludeDates, unitString);
                        if (!earliestDate || date < earliestDate) earliestDate = date;
                        if (!latestDate || date > latestDate) latestDate = date;
                    }
                });
            } else {
                while (itemIndex < itemsCount) {
                    const dateKey = getDateStr(currentDate);
                    if (limitDate && currentDate > limitDate) break; 
                    if (!isExcluded(currentDate, excludeWeekdays, excludeDates)) {
                        if (!planData[dateKey]) planData[dateKey] = [];
                        const studiedItems = [];
                        for (let i = 0; i < dailyAmount && itemIndex < itemsCount; i++) {
                            studiedItems.push(items[itemIndex++]);
                        }
                        if (studiedItems.length > 0 && shouldGeneratePrimaryTask) {
                             const rangeString = getRangeString(studiedItems);
                             const studyTask = {
                                 planId: id,
                                 text: `${studyPrefix}: ${rangeString}${unitString}`,
                                 color: color,
                                 isStudy: true,
                                 item: rangeString,
                                 unit: unitContent,
                             };
                             planData[dateKey].push(studyTask);
                        }
                        scheduleReviews(currentDate, studiedItems, planData, id, reviewPrefix, showReview, excludeWeekdays, excludeDates, unitString);
                        if (!earliestDate || currentDate < earliestDate) earliestDate = currentDate;
                        if (!latestDate || currentDate > latestDate) latestDate = currentDate;
                    }
                    if (itemIndex >= itemsCount) break;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
        });
        
        latestPlan = planData;
        renderCalendar(planData);
        updateSelectAllCheckboxState(); 
    }

    function scheduleReviews(studyDate, studyItems, allPlans, id, reviewPrefix, showReview, excludeWeekdays, excludeDates, unitString = '') {
        if (!showReview || studyItems.length === 0) return;
        const intervals = [1, 2, 4, 7, 15];
        const color = planColors[id];
        intervals.forEach(offset => {
            let reviewDate = new Date(studyDate);
            reviewDate.setDate(reviewDate.getDate() + offset);
            let rDate = new Date(reviewDate);
            let maxReviewSearchDays = 60; 
            let searchCount = 0;
            while (isExcluded(rDate, excludeWeekdays, excludeDates) && searchCount < maxReviewSearchDays) {
                rDate.setDate(rDate.getDate() + 1);
                searchCount++;
            }
            if (searchCount >= maxReviewSearchDays) return; 
            let rDateStr = getDateStr(rDate);
            const reviewTask = {
                planId: id,
                text: `${reviewPrefix}: ${getRangeString(studyItems)}${unitString}`, 
                color: color,
                isStudy: false,
                item: getRangeString(studyItems),
                unit: unitString,
            };
            if (!allPlans[rDateStr]) allPlans[rDateStr] = [];
            allPlans[rDateStr].push(reviewTask);
        });
    }

    function isLightColor(hexColor) {
        const c = hexColor.substring(1); 
        const rgb = parseInt(c, 16); 
        const r = (rgb >> 16) & 0xff; 
        const g = (rgb >> 8) & 0xff; 
        const b = (rgb >> 0) & 0xff; 
        const luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
        return luma > 200; 
    }

    function renderCalendar(planData) {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';
        const dates = Object.keys(planData);
        let startDate = new Date();
        let endDate = new Date();
        const todayKey = getDateStr(new Date());

        if (dates.length > 0) {
            dates.sort();
            startDate = new Date(dates[0]);
            endDate = new Date(dates[dates.length - 1]);
        } else {
            startDate.setDate(1);
            endDate.setMonth(endDate.getMonth() + 2); 
            endDate.setDate(0);
        }

        startDate.setDate(1);
        endDate.setMonth(endDate.getMonth() + 1);
        endDate.setDate(0); 

        let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

        while (currentMonth <= endDate) {
            const monthId = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
            const monthContainer = document.createElement('div');
            monthContainer.className = 'month-container';

            const monthHeader = document.createElement('div');
            monthHeader.className = 'month-header';
            monthHeader.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleMonthContent('${monthId}')">
                    <span>${currentMonth.getFullYear()} / ${currentMonth.getMonth() + 1}</span>
                    <span id="month-toggle-${monthId}" class="toggle-icon">▲</span>
                </div>
            `;
            monthContainer.appendChild(monthHeader);

            const contentWrapper = document.createElement('div');
            contentWrapper.id = `month-content-${monthId}`;
            contentWrapper.className = 'month-content-wrapper';
            contentWrapper.style.transition = 'max-height 0.3s ease-out';
            contentWrapper.style.overflow = 'hidden';
            monthContainer.appendChild(contentWrapper);

            const grid = createMonthGrid(currentMonth.getFullYear(), currentMonth.getMonth(), planData, todayKey, monthId);
            contentWrapper.appendChild(grid);
            calendar.appendChild(monthContainer);
            
            if (localStorage.getItem(`month-collapsed-${monthId}`) === 'true') {
                 contentWrapper.style.maxHeight = '0';
                 document.getElementById(`month-toggle-${monthId}`).textContent = '▼';
            } else {
                 contentWrapper.style.maxHeight = '3000px'; // 估計值，保持展開
            }
            currentMonth.setMonth(currentMonth.getMonth() + 1);
        }
    }

    function createMonthGrid(year, month, planData, todayKey, monthId) {
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        const weekdayNames = currentLang === 'zh' ? weekdayMap : weekdayMap_en;

        for (let i = 0; i < 7; i++) {
            const dayHeader = document.createElement('div');
            dayHeader.className = `weekday-header${(i === 0 || i === 6) ? ' weekday-weekend' : ''}`;
            dayHeader.textContent = weekdayNames[i];
            grid.appendChild(dayHeader);
        }

        let firstDayOfMonth = new Date(year, month, 1);
        let startOffset = firstDayOfMonth.getDay();
        for (let i = 0; i < startOffset; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-day';
            grid.appendChild(emptyDiv);
        }

        let dayCursor = firstDayOfMonth;
        while (dayCursor.getMonth() === month) {
            const d = dayCursor.getDate();
            const dayOfWeek = dayCursor.getDay(); 
            const dateKey = getDateStr(dayCursor);
            const tasks = planData[dateKey] || [];
            const hasTasks = tasks.length > 0;
            const isToday = dateKey === todayKey;

            const day = document.createElement("div");
            day.className = `day ${isToday ? 'today' : ''}`;

            // 週六日背景 (已移除，改用統一白底)
            // if (dayOfWeek === 0 || dayOfWeek === 6) { day.style.backgroundColor = 'var(--bg-body)'; } 

            const dateHeaderContainer = document.createElement('div');
            dateHeaderContainer.className = 'date-header-container';
            dateHeaderContainer.style.display = 'flex';
            dateHeaderContainer.style.justifyContent = 'space-between';

            const dateOnlySpan = document.createElement('span');
            dateOnlySpan.className = 'date-only';
            dateOnlySpan.textContent = d;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'day-checkbox';
            checkbox.dataset.date = dateKey;
            checkbox.onchange = updateDaySelection; 
            
            const checkedState = JSON.parse(localStorage.getItem('checkedDays') || '{}');
            if (checkedState[dateKey]) checkbox.checked = true;
            if (!hasTasks) checkbox.style.visibility = 'hidden';

            dateHeaderContainer.appendChild(dateOnlySpan);
            dateHeaderContainer.appendChild(checkbox);
            day.appendChild(dateHeaderContainer);

            tasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task';
                taskDiv.textContent = task.text;
                const bgColor = task.color;
                taskDiv.style.backgroundColor = bgColor;
                // 使用左側 border 來增加層次感
                taskDiv.style.borderLeftColor = shadeColor(bgColor, -20);
                
                if (isLightColor(bgColor)) taskDiv.style.color = '#3B3E3D';
                else taskDiv.style.color = '#FFFFFF';

                day.appendChild(taskDiv);
            });
            grid.appendChild(day);
            dayCursor.setDate(dayCursor.getDate() + 1);
        }

        let endOffset = 7 - grid.children.length % 7;
        if (endOffset < 7 && endOffset > 0) {
            for (let i = 0; i < endOffset; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-day';
                grid.appendChild(emptyDiv);
            }
        }
        return grid;
    }
    
    // 輔助函數：調整顏色深淺 (用於 Task 左側線條)
    function shadeColor(color, percent) {
        var R = parseInt(color.substring(1,3),16);
        var G = parseInt(color.substring(3,5),16);
        var B = parseInt(color.substring(5,7),16);
        R = parseInt(R * (100 + percent) / 100);
        G = parseInt(G * (100 + percent) / 100);
        B = parseInt(B * (100 + percent) / 100);
        R = (R<255)?R:255;  
        G = (G<255)?G:255;  
        B = (B<255)?B:255;  
        var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
        var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
        var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
        return "#"+RR+GG+BB;
    }

    function updateDaySelection(event) {
        const checkbox = event.target;
        const dateKey = checkbox.dataset.date;
        let checkedDays = JSON.parse(localStorage.getItem('checkedDays') || '{}');
        if (checkbox.checked) checkedDays[dateKey] = true;
        else delete checkedDays[dateKey];
        localStorage.setItem('checkedDays', JSON.stringify(checkedDays));
        updateSelectAllCheckboxState();
    }

    function updateSelectAllCheckboxState() {
        const allCheckboxes = document.querySelectorAll('.day-checkbox');
        const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => cb.style.visibility !== 'hidden');
        let checkedCount = 0;
        visibleCheckboxes.forEach(checkbox => {
             if (checkbox.checked) checkedCount++;
        });
        const selectAllCheckbox = document.getElementById('selectAllDays');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = visibleCheckboxes.length > 0 && checkedCount === visibleCheckboxes.length;
        }
    }

    function toggleMonthContent(monthId) {
        const content = document.getElementById(`month-content-${monthId}`);
        const icon = document.getElementById(`month-toggle-${monthId}`);
        if (content && icon) {
            const isCollapsed = content.style.maxHeight === '0px';
            if (!isCollapsed) { // Collapse it
                content.style.maxHeight = '0px';
                icon.textContent = '▼';
                localStorage.setItem(`month-collapsed-${monthId}`, 'true');
            } else { // Expand it
                content.style.maxHeight = '3000px';
                icon.textContent = '▲';
                localStorage.removeItem(`month-collapsed-${monthId}`);
            }
        }
    }

    function randomizeColor(id) {
        const color = getRandomColor();
        document.getElementById(`colorPicker-${id}`).value = color;
        // document.querySelector(`.plan-group[data-id="${id}"]`).style.backgroundColor = color; 
        document.querySelector(`.plan-group[data-id="${id}"]`).style.borderLeft = `5px solid ${color}`;
        planColors[id] = color;
        savePlanData(id); 
    }

    function updatePlanTitle(id) {
        const titleElement = document.getElementById(`plan-title-${id}`);
        const unitInput = document.getElementById(`unit-${id}`);
        if (titleElement) {
            const unit = unitInput?.value?.trim();
            const headerText = translations[currentLang].planHeader;
            titleElement.textContent = unit ? `${unit}` : `${headerText} #${id}`;
        }
        savePlanData(id);
    }
    
    function toggleCustomText(id) {
        const customDiv = document.getElementById(`customTextDiv-${id}`);
        const checkbox = document.getElementById(`showCustomCheckbox-${id}`);
        if (customDiv && checkbox) {
            customDiv.style.display = checkbox.checked ? 'block' : 'none';
            savePlanData(id); 
        }
    }

    function toggleExcludeDatesInput(id) {
        const customDiv = document.getElementById(`excludeDatesDiv-${id}`);
        const checkbox = document.getElementById(`excludeCustomDates-${id}`);
        if (customDiv && checkbox) {
            customDiv.style.display = checkbox.checked ? 'block' : 'none';
            savePlanData(id); 
        }
    }

    function toggleExecutionDatesInput(id) {
        const customDiv = document.getElementById(`executionDatesDiv-${id}`);
        const checkbox = document.getElementById(`useExecutionDatesCheckbox-${id}`);
        if (customDiv && checkbox) {
            customDiv.style.display = checkbox.checked ? 'block' : 'none';
            savePlanData(id); 
        }
    }

    function formatTaskForCalendar(taskObj) {
        const planTitle = document.getElementById(`unit-${taskObj.planId}`)?.value.trim() || (currentLang === 'zh' ? `記憶計劃 #${taskObj.planId}` : `Memory Plan #${taskObj.planId}`);
        return `${planTitle}: ${taskObj.text}`;
    }

    function addToGoogleCalendar() {
        if (Object.keys(latestPlan).length === 0) {
            alert(currentLang === 'zh' ? '請先產生記憶計劃！' : 'Please generate the memory plan first!');
            return;
        }
        const gcTitleOption = document.querySelector('input[name="gcTitleOption"]:checked').value;
        const keys = Object.keys(latestPlan).sort();
        const checkedDays = JSON.parse(localStorage.getItem('checkedDays') || '{}');
        let mergedTitle = '';
        let mergedDescription = '';
        let eventCount = 0;

        keys.forEach(dateStr => {
            if (checkedDays[dateStr]) {
                const tasks = latestPlan[dateStr];
                if (gcTitleOption === 'merge') {
                    const mergedTasksText = tasks.map(t => t.text).join(' / ');
                    const representativeTask = tasks.find(t => t.isStudy) || tasks[0];
                    if (!representativeTask) return;
                    const unitInput = document.getElementById(`unit-${representativeTask.planId}`);
                    const planTitle = unitInput ? unitInput.value : (currentLang === 'zh' ? `記憶計劃` : `Memory Plan`);
                    mergedTitle = `${planTitle} - ${mergedTasksText}`;
                    mergedDescription = tasks.map(t => `• ${t.text}`).join('\n');
                    const date = new Date(dateStr);
                    const startYear = date.getFullYear();
                    const startMonth = date.getMonth() + 1;
                    const startDate = date.getDate();
                    const title = encodeURIComponent(mergedTitle);
                    const details = encodeURIComponent(mergedDescription);
                    const dates = `${startYear}${String(startMonth).padStart(2, '0')}${String(startDate).padStart(2, '0')}`;
                    window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&dates=${dates}/${dates}&sf=true&output=xml`, '_blank');
                    eventCount++;
                } else {
                    tasks.forEach(taskObj => {
                        const date = new Date(dateStr);
                        const startYear = date.getFullYear();
                        const startMonth = date.getMonth() + 1;
                        const startDate = date.getDate();
                        const title = encodeURIComponent(formatTaskForCalendar(taskObj));
                        const details = encodeURIComponent(taskObj.text);
                        const dates = `${startYear}${String(startMonth).padStart(2, '0')}${String(startDate).padStart(2, '0')}`;
                        window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&dates=${dates}/${dates}&sf=true&output=xml`, '_blank');
                        eventCount++;
                    });
                }
            }
        });
        if (eventCount === 0) alert(currentLang === 'zh' ? '請勾選至少一個日期！' : 'Please check at least one day!');
    }

    function downloadCSV() {
        if (Object.keys(latestPlan).length === 0) {
            alert(currentLang === 'zh' ? '請先產生記憶計劃！' : 'Please generate the memory plan first!');
            return;
        }
        const gcTitleOption = document.querySelector('input[name="gcTitleOption"]:checked').value;
        const keys = Object.keys(latestPlan).sort();
        const checkedDays = JSON.parse(localStorage.getItem('checkedDays') || '{}');
        let csv = "Subject,Start Date,Start Time,End Date,End Time,All Day Event,Description,Location\n";
        const rows = [];
        const emptyFields = ',,'; 
        const allDayEvent = 'TRUE';

        if (gcTitleOption === 'merge') {
            keys.forEach(dateStr => {
                if (checkedDays[dateStr]) { 
                    const tasks = latestPlan[dateStr];
                    const mergedTasksText = tasks.map(t => t.text).join(' / ');
                    const representativeTask = tasks.find(t => t.isStudy) || tasks[0];
                    if (!representativeTask) return;
                    const unitInput = document.getElementById(`unit-${representativeTask.planId}`);
                    const planTitle = unitInput ? unitInput.value : (currentLang === 'zh' ? `記憶計劃` : `Memory Plan`);
                    const subject = `"${planTitle} - ${mergedTasksText}"`;
                    const dateParts = dateStr.split('-');
                    const csvDateStr = `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}/${dateParts[0]}`;
                    const row = `${subject},${csvDateStr}${emptyFields}${csvDateStr}${emptyFields}${allDayEvent},,`;
                    rows.push(row);
                }
            });
        } else {
            keys.forEach(dateStr => {
                if (checkedDays[dateStr]) { 
                    latestPlan[dateStr].forEach(taskObj => {
                        const subject = `"${formatTaskForCalendar(taskObj)}"`;
                        const dateParts = dateStr.split('-');
                        const csvDateStr = `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}/${dateParts[0]}`;
                        const row = `${subject},${csvDateStr}${emptyFields}${csvDateStr}${emptyFields}${allDayEvent},,`;
                        rows.push(row);
                    });
                }
            });
        }
        csv += rows.join("\n");
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", "google_calendar_import.csv");
        link.click();
    }

    function toggleAllCheckboxes() {
        const selectAll = document.getElementById('selectAllDays').checked;
        const checkedDays = JSON.parse(localStorage.getItem('checkedDays') || '{}');
        document.querySelectorAll('.day-checkbox').forEach(checkbox => {
            if (checkbox.style.visibility !== 'hidden') {
                checkbox.checked = selectAll;
                if (selectAll) checkedDays[checkbox.dataset.date] = true;
                else delete checkedDays[checkbox.dataset.date];
            }
        });
        localStorage.setItem('checkedDays', JSON.stringify(checkedDays));
    }

    function toggleTheme() {
        const body = document.body;
        const button = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');
        const themeTextSpan = button ? button.querySelector('[data-i18n-id="toggleThemeBtn"]') : null;
        
        const isDark = body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');

        if(themeIcon) {
            themeIcon.classList.remove(isDark ? 'fa-moon' : 'fa-sun');
            themeIcon.classList.add(isDark ? 'fa-sun' : 'fa-moon');
        }
        if(themeTextSpan) {
            themeTextSpan.textContent = isDark 
                ? (currentLang === 'zh' ? '日間' : 'Light') 
                : (currentLang === 'zh' ? '夜間' : 'Dark');
        }
    }

    function toggleLanguage() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        localStorage.setItem('language', currentLang);
        applyTranslation(currentLang);
        renderPlans(); 
        generatePlan(); 
        loadTheme();
    }

    function applyTranslation(lang) {
        const t = translations[lang];
        const titleElement = document.querySelector('title');
        const titleKey = titleElement.getAttribute('data-i18n');
        if (t[titleKey]) titleElement.textContent = t[titleKey];

        document.querySelectorAll('[data-i18n], [data-i18n-id]').forEach(element => {
            const key = element.getAttribute('data-i18n') || element.getAttribute('data-i18n-id');
            if (element.tagName === 'BUTTON' || element.tagName === 'H1') {
                if (t[key]) {
                    // 保留 icon
                    const icon = element.querySelector('i');
                    if(icon) {
                         // 簡單處理，直接更新文字節點
                         // element.innerHTML = ''; element.appendChild(icon); element.append(" " + t[key]);
                         // 這裡偷懶一下，只更新 span
                         const span = element.querySelector('span');
                         if(span) span.textContent = t[key];
                         else element.childNodes[element.childNodes.length-1].nodeValue = t[key];
                    } else {
                        element.textContent = t[key];
                    }
                }
            } 
            else if (element.tagName === 'SPAN' || element.tagName === 'LABEL' || element.tagName === 'P') {
                if (t[key]) {
                    if (element.children.length === 0) element.textContent = t[key];
                    else if (element.tagName === 'LABEL' && element.querySelector('span')) {
                        const textSpan = element.querySelector('span');
                        if (textSpan) textSpan.textContent = t[key];
                    }
                }
            }
        });

        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            if (t[key]) element.placeholder = t[key];
        });

        renderPlans();
        Object.keys(allPlansData).map(Number).forEach(id => {
            updatePlanTitle(id);
            updateRequiredDays(id);
        });
        loadTheme();
    }

    function loadLanguage() {
        const savedLang = localStorage.getItem('language');
        if (savedLang && translations[savedLang]) currentLang = savedLang;
        applyTranslation(currentLang);
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        const body = document.body;
        const button = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon'); 
        const themeTextSpan = button ? button.querySelector('[data-i18n-id="toggleThemeBtn"]') : null;
        
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            if(themeIcon) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
            if(themeTextSpan) themeTextSpan.textContent = currentLang === 'zh' ? '日間' : 'Light'; 
        } else {
            body.classList.remove('dark-mode');
            if(themeIcon) {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
            if(themeTextSpan) themeTextSpan.textContent = currentLang === 'zh' ? '夜間' : 'Dark'; 
        }
    }

    loadPlansData();
    loadLanguage();
    loadTheme();
    if (Object.keys(allPlansData).length === 0) addPlan(); 
    generatePlan(); 
    setTimeout(updateSelectAllCheckboxState, 100); 

</script>
</body>
</html>
