<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
  
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
  
  <title data-i18n="pageTitle">學習計劃表產生器</title>
  <link rel="icon" type="image/x-icon" href="https://weiyenchang.github.io/portfolio/LearningPlanFavIcon.png">

  <style>
    /* CSS Variables for Theme */
    :root {
      /* Light Mode */
      --bg-body: #F5F7FA;
      --bg-gradient-start: #DCE5F9;
      --bg-gradient-end: rgba(255,255,255,0);
      
      --bg-card: #FFFFFF;
      --bg-input: #F0F2F5;
      
      --text-main: #111111;
      --text-secondary: #6B7280;
      
      --accent-black: #111111;
      --accent-hover: #333333;
      
      --border-color: #E5E7EB;
      --border-focus: #111;
      
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.03);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.03);
      --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.05);

      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 12px;
      --radius-pill: 100px;

      --highlight-color: #FF7043;
      --calendar-grid-line: #F0F0F0;
    }

    .dark-mode {
      /* Dark Mode */
      --bg-body: #000000;
      --bg-gradient-start: #1C1C1E;
      
      --bg-card: #1C1C1E;
      --bg-input: #2C2C2E;
      
      --text-main: #FFFFFF;
      --text-secondary: #8E8E93;
      
      --accent-black: #FFFFFF;
      --accent-hover: #E5E5E5;
      
      --border-color: #38383A;
      --border-focus: #fff;
      
      --shadow-sm: none;
      --shadow-md: none;
      --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.5);

      --highlight-color: #FF9F0A;
      --calendar-grid-line: #2C2C2E;
    }
    
    /* Dark Mode Date Picker Icon Fix */
    .dark-mode input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        opacity: 0.8;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
      padding: 0;
      margin: 0;
      background-color: var(--bg-body); 
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: relative;
      overflow-x: hidden;
    }

    /* Ambient Background Glow */
    body::before {
      content: '';
      position: absolute;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 400px;
      background: radial-gradient(ellipse at center, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 70%);
      filter: blur(80px);
      z-index: -1;
      pointer-events: none;
      opacity: 0.8;
    }
    
    .app-container {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .main-content {
        flex: 1;
        padding: 40px;
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
        box-sizing: border-box;
        padding-top: 0; 
    }

    /* Header - Sticky Top & Glassmorphism */
    .header-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 20px;
        border-radius: 0 0 10px 10px;
        position: sticky;
        top: 0;
        z-index: 1000;
        
        background-color: rgba(245, 247, 250, 0.85); 
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        
        transition: background-color 0.3s ease;
        padding-left: 20px; 
        padding-right: 20px;
        margin-left: -20px; 
        margin-right: -20px;
        border-bottom: 1px solid transparent;
    }
    
    .dark-mode .header-main {
        background-color: rgba(28, 28, 30, 0.8);
        border-bottom: 0.5px solid rgba(255,255,255,0.1);
        border-radius: 0 0 10px 10px;
    }

    .header-title-area {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .svg_icon {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        cursor: pointer;
        transition: box-shadow 0.3s ease;
    }
    .svg_icon svg {
        fill: var(--text-main);
        transition: fill 0.3s ease;
        width: 40px;
        height: 40px;
    }

    h1 {
      font-size: 19px;
      letter-spacing: 0.3px; 
      font-weight: 700; 
      margin: 0;
      color: var(--text-main);
      line-height: 1.2;
    }
    .header-title-area p {
        font-size: 14px;
        margin: 4px 0 0 0;
        color: var(--text-secondary);
    }

    /* Controls & Dropdowns */
    .calendar-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .header_btn {
        display: flex;
        gap: 10px;
        position: relative;
    }
    .header_btn > button, .dropdown-btn {
        border-radius: var(--radius-pill); 
        padding: 8px 16px; 
        font-size: 14px;
        font-weight: 500;
        background-color: var(--bg-card);
        border: 1px solid transparent; 
        box-shadow: var(--shadow-sm);
        color: var(--text-main);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        height: 40px;
        white-space: nowrap;
    }
    .header_btn > button:hover, .dropdown-btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .dark-mode .header_btn > button, .dark-mode .dropdown-btn {
        background-color: rgba(255, 255, 255, 0.1); 
        border: none;
        color: #FFFFFF;
        box-shadow: none; 
    }
    .dark-mode .header_btn > button:hover, .dark-mode .dropdown-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .hamburger-btn {
        display: none; 
        font-size: 20px;
        background: transparent;
        border: none;
        color: var(--text-main);
        cursor: pointer;
        padding: 10px;
    }

    /* Dropdown Logic */
    .dropdown {
        position: relative;
        display: inline-block;
    }
    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        top: 45px;
        background-color: var(--bg-card);
        min-width: 240px;
        box-shadow: var(--shadow-lg);
        border-radius: var(--radius-md);
        padding: 10px;
        z-index: 1000;
        border: 1px solid var(--border-color);
        flex-direction: column;
        gap: 5px;
    }
    .dropdown-content.show {
        display: flex;
    }
    .dropdown-content button {
        width: 100%;
        text-align: left;
        padding: 10px;
        background: transparent;
        border: none;
        color: var(--text-main);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .dropdown-content button:hover {
        background-color: var(--bg-input);
    }
    .dropdown-divider {
        height: 1px;
        background-color: var(--border-color);
        margin: 5px 0;
    }
    .dropdown-radio-group {
        padding: 5px 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .dropdown-radio-group label {
        font-size: 13px;
        color: var(--text-main);
        cursor: pointer;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Layout */
    .container {
      display: flex;
      gap: 30px;
      margin-top: 20px;
      align-items: flex-start;
    }
    .sidebar {
      flex: 1;
      max-width: 370px;
      min-width: 370px; 
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .main {
      flex: 3;
      min-width: 0;
    }

    /* Cards */
    .plan-group {
      background-color: var(--bg-card);
      border: none;
      padding: 20px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .plan-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 0 15px 0; 
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 15px;
    }
    .plan-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
    }
    .plan-header .toggle-icon {
        font-size: 14px;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--bg-input);
        color: var(--text-main);
    }

    /* Inputs */
    label {
      margin: 12px 0 6px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      display: block;
    }
    input[type="text"], input[type="number"], input[type="date"], textarea {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      font-size: 14px;
      background-color: var(--bg-input);
      color: var(--text-main);
      box-sizing: border-box;
      transition: all 0.2s;
    }
    input:focus, textarea:focus {
        outline: none;
        background-color: var(--bg-card);
        border-color: var(--border-focus);
        box-shadow: 0 0 0 2px rgba(0,0,0,0.05);
    }
    
    /* Sidebar Buttons */
    .sidebar-actions {
        display: flex; 
        gap: 10px;
        flex-wrap: wrap;
    }
    .sidebar-actions button {
        background-color: var(--accent-black);
        color: var(--bg-card);
        border: none;
        flex: 1;
        min-width: 140px;
        cursor: pointer;
        justify-content: center;
        padding: 12px;
        border-radius: var(--radius-pill);
        font-weight: 600;
        box-shadow: var(--shadow-sm);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
    }
    
    .dark-mode .sidebar-actions button {
        background-color: #F2F2F7 !important; 
        color: #000000 !important; 
    }
    .dark-mode .sidebar-actions button:hover {
        background-color: #E5E5EA !important; 
    }

    .sidebar-actions button:hover {
        background-color: var(--accent-hover);
    }

    .delete-btn {
      width: 30px;
      height: 30px;
      border-radius: 50% !important;
      padding: 0 !important;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--bg-input) !important;
      color: var(--text-main) !important;
      border: none !important;
      margin: 0 !important;
      font-size: 12px;
      cursor: pointer;
    }
    .delete-btn:hover {
        background-color: #ffebee !important;
        color: #d32f2f !important;
    }

    .color-label { 
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        justify-content: space-between;
    }
    input[type="color"]::-webkit-color-swatch {
        position:absolute;
        top:-1px;
        left:-1px;
        right:-1px;
        bottom:-1px;
        box-sizing: border-box;
        border:1px solid transparent;
    }
    .color-label input[type="color"] {
         -webkit-appearance: none;
        position:relative;
        margin:0 5px;
        width: 30px;
        height: 30px;
        border-radius: 100px;
        border: 1px solid rgba(0,0,0,0.1);
        padding: 0;
        cursor: pointer;
    }
    .color-label button {
        width: auto; padding: 5px 12px; margin: 0; font-size: 12px;
        border-radius: 20px;
        border:none;
    }

    /* Palette Suggestion Styles */
    .palette-section {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-input);
        padding: 15px;
        border-radius: var(--radius-md);
    }
    .palette-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .palette-header span {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .palette-controls {
        display: flex;
        gap: 6px;
        justify-content: flex-end;
    }
    .palette-btn {
        width: auto;
        padding: 4px 10px;
        font-size: 12px;
        background: var(--bg-card);
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 20px;
        box-shadow: var(--shadow-sm);
        color: var(--text-main);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .palette-btn:hover {
        background: var(--bg-card);
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
    }
    .palette-btn.apply-all {
        border: none;
    }
    .dark-mode .palette-btn.apply-all {
        color: #F5F7FA;
    }
    .palette-btn.apply-all:hover {
        opacity: 0.9;
    }
    
    .palette-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .palette-row {
        display: flex;
        gap: 8px;
        justify-content: space-between;
        height: 35px;
    }
    .palette-swatch {
        flex: 1;
        height: 100%;
        border-radius: 8px;
        cursor: default;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0,0,0,0.05);
        position: relative;
    }

    /* Checkbox & Radio */
    input[type="checkbox"], input[type="radio"] {
        accent-color: var(--text-main);
        width: 16px; height: 16px; cursor: pointer;
    }
    .weekday-checkboxes {
        display: flex; justify-content: space-between;
        background: var(--bg-input);
        padding: 5px; border-radius: var(--radius-md);
    }
    .weekday-checkboxes label {
        margin: 0; padding: 5px; 
        display: flex; flex-direction: column; align-items: center;
        font-size: 10px; cursor: pointer; color: var(--text-main);
    }

    /* Calendar */
    #calendar {
      display: flex; 
      flex-direction: column;
      gap: 30px; 
    }
    .month-container {
        background-color: var(--bg-card);
        border-radius: var(--radius-lg);
        border: none;
        box-shadow: var(--shadow-md);
        overflow: hidden;
        min-width: 0; 
    }
    
    .month-content-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .month-header {
        font-size: 20px;
        font-weight: 700;
        padding: 20px 25px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-main);
        background: var(--bg-card);
    }
    .month-header .toggle-icon {
        color: var(--text-secondary);
        font-size: 16px;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0;
        border: none;
        background: var(--bg-card);
        min-width: 600px;
    }
    .weekday-header {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 12px;
      text-align: center;
      padding: 15px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border-color);
    }
    .weekday-weekend { color: var(--highlight-color) !important; }

    .day {
      border: none;
      box-shadow: inset -1px -1px 0 var(--calendar-grid-line);
      background-color: var(--bg-card);
      padding: 10px 15px;
      min-height: 120px;
      position: relative;
      transition: background-color 0.2s;
    }
    .day:hover { background-color: rgba(0,0,0,0.01); }
    .dark-mode .day:hover { background-color: rgba(255,255,255,0.02); }
    .day.today {
        border: none !important;
        box-shadow: inset 0 0 0 2px var(--highlight-color), inset -1px -1px 0 var(--calendar-grid-line);
    }
    .empty-day {
        background-color: transparent;
        box-shadow: inset -1px -1px 0 var(--calendar-grid-line);
    }
    .date-only {
      font-weight: 700;
      font-size: 24px;
      color: var(--text-main);
      opacity: 0.8;
      margin-bottom: 8px;
    }
    .task {
      padding: 4px 10px;
      margin-top: 5px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      border-left: 3px solid rgba(0,0,0,0.1);
    }
    label span{
        margin-bottom: 5px;
    }
    .sidebar-actions .fa-solid, .fas{
       margin-right: 10px; 
    }

    /* Footer */
    .app-footer {
        background-color: #2d2d2d;
        color: #f5f5f5;
        text-align: center;
        padding: 20px;
        margin-top: 40px;
        font-size: 14px;
        font-weight: 500;
        letter-spacing: 0.5px;
        position: relative; 
    }
    
    .visit-counter {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%); 
        font-size: 12px;
        opacity: 0.8;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* RWD */
    @media (max-width: 900px) {
        .container {
            flex-direction: column;
        }
        .sidebar {
            width: 100%;
            max-width: 100%;
            min-width: 0;
        }
        .main {
            width: 100%;
        }
    }

    /* Mobile Header & Hamburger Menu */
    @media (max-width: 768px) {
      .app-container { flex-direction: column; }
      .main-content { padding: 15px; padding-top: 0; } 
      
      .header-main { 
          flex-wrap: nowrap; 
          padding-left: 15px;
          padding-right: 15px;
          margin-left: -15px;
          margin-right: -15px;
      }
      .header-title-area { 
          flex-grow: 1;
      }
      
      .calendar-controls {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background-color: var(--bg-card);
          box-shadow: 0 10px 20px rgba(0,0,0,0.1);
          flex-direction: column;
          align-items: stretch;
          padding: 15px;
          border-bottom: 1px solid var(--border-color);
          z-index: 999;
      }
      .calendar-controls.active {
          display: flex;
      }
      
      .header_btn {
          flex-direction: column;
          width: 100%;
          gap: 10px;
      }
      .header_btn > button, .dropdown-btn {
          width: 100%;
          justify-content: center;
      }
      
      .dropdown {
          width: 100%;
      }
      .dropdown-content {
          position: static; 
          width: 100%;
          box-shadow: none;
          border: 1px solid var(--border-color);
          background-color: var(--bg-input);
          margin-top: 5px;
          box-sizing: border-box;
      }

      .hamburger-btn {
          display: block;
      }
      
      .day {
          padding: 5px;
          min-height: 80px;
      }
      .date-only {
          font-size: 18px;
      }
      .task {
          font-size: 11px;
          padding: 3px 6px;
      }
      .calendar-grid {
          min-width: 100%; 
      }
      @media (max-width: 400px) {
          .calendar-grid {
              min-width: 500px;
          }
      }
      
      /* Mobile Footer */
      .app-footer {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }
      .visit-counter {
          position: static; 
          transform: none;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="main-content">
      
      <div class="header-main">
          <div class="header-title-area">
              <div class="svg_icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,14a1,1,0,1,0-1-1A1,1,0,0,0,12,14Zm5,0a1,1,0,1,0-1-1A1,1,0,0,0,17,14Zm-5,4a1,1,0,1,0-1-1A1,1,0,0,0,12,18Zm5,0a1,1,0,1,0-1-1A1,1,0,0,0,17,18ZM7,14a1,1,0,1,0-1-1A1,1,0,0,0,7,14ZM19,4H18V3a1,1,0,0,0-2,0V4H8V3A1,1,0,0,0,6,3V4H5A3,3,0,0,0,2,7V19a3,3,0,0,0,3,3H19a3,3,0,0,0,3-3V7A3,3,0,0,0,19,4Zm1,15a1,1,0,0,1-1,1H5a1,1,0,0,1-1-1V10H20ZM20,8H4V7A1,1,0,0,1,5,6H19a1,1,0,0,1,1,1ZM7,18a1,1,0,1,0-1-1A1,1,0,0,0,7,18Z"/></svg>
              </div>
              <div>
                <h1 data-i18n="mainHeader">學習計劃表</h1>
                <p data-i18n-id="headerSubtitle">Visual Learning Planner</p>
              </div>
          </div>
          
          <button class="hamburger-btn" onclick="toggleMobileMenu()">
              <i class="fa-solid fa-bars"></i>
          </button>

          <div class="calendar-controls" id="mobileMenu">
              <div class="header_btn">
                  <div class="dropdown">
                      <button onclick="toggleDropdown('backupDropdown')" class="dropdown-btn">
                          <i class="fa-solid fa-file-import"></i> <span data-i18n="importBtnLabel">匯入</span>
                      </button>
                      <div id="backupDropdown" class="dropdown-content">
                          <button onclick="exportPlanSettingsCSV()"><i class="fa-solid fa-download"></i> <span data-i18n-id="exportSettingsBtn">匯出設定 CSV</span></button>
                          <div class="dropdown-divider"></div>
                          <button onclick="document.getElementById('importFile').click()"><i class="fa-solid fa-upload"></i> <span data-i18n-id="importSettingsBtn">匯入設定 CSV</span></button>
                          <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="handleImportFile(this)">
                      </div>
                  </div>

                  <div class="dropdown">
                      <button onclick="toggleDropdown('gcDropdown')" class="dropdown-btn">
                          <i class="fa-brands fa-google"></i> <span>Google Calendar</span>
                      </button>
                      <div id="gcDropdown" class="dropdown-content">
                           <div class="dropdown-radio-group">
                                <label style="font-weight: 600; margin-bottom: 5px;" data-i18n-id="gcTitleSettingLabel">顯示設定:</label>
                                <label>
                                    <input type="radio" id="mergePlans" name="gcTitleOption" value="merge" checked>
                                    <span data-i18n-id="mergePlansLabel">合併顯示</span>
                                </label>
                                <label>
                                    <input type="radio" id="separatePlans" name="gcTitleOption" value="separate">
                                    <span data-i18n-id="separatePlansLabel">獨立顯示</span>
                                </label>
                           </div>
                           <div class="dropdown-divider"></div>
                           <button onclick="addToGoogleCalendar()"><i class="fa-regular fa-calendar-plus"></i> <span data-i18n-id="addToCalendarBtnText">加入行事曆</span></button>
                           <button onclick="downloadCSV()"><i class="fa-solid fa-file-csv"></i> <span data-i18n="downloadGCcsv">下載 CSV</span></button>
                      </div>
                  </div>

                  <div class="dropdown">
                      <button onclick="toggleDropdown('checklistDropdown')" class="dropdown-btn">
                          <i class="fa-solid fa-table-list"></i> <span data-i18n="checklistBtnLabel">追蹤檢核表</span>
                      </button>
                      <div id="checklistDropdown" class="dropdown-content">
                          <button onclick="openInGoogleSheets()">
                              <i class="fa-solid fa-file-excel"></i> <span data-i18n-id="openGoogleSheetBtn">使用 Google Sheet 建立</span>
                          </button>
                          <button onclick="downloadExcelChecklist()">
                              <i class="fa-solid fa-download"></i> <span data-i18n-id="downloadExcelBtn">下載 Excel (.xlsx)</span>
                          </button>
                      </div>
                  </div>

                  <button onclick="toggleLanguage()" id="lang-toggle-btn">
                      <i class="fa-solid fa-language"></i>
                      <span data-i18n="toggleLangBtn">中/En</span>
                  </button>
                  <button onclick="toggleTheme()" id="theme-toggle-btn">
                      <i id="theme-icon" class="fa-solid fa-moon"></i>
                      <span data-i18n-id="toggleThemeBtn">夜間</span>
                  </button>
              </div>
          </div>
      </div>
      
      <div class="container">
        
        <div class="sidebar">
          <div class="sidebar-actions"> 
             <button onclick="addPlan()" data-i18n="addPlanBtn"><i class="fa-solid fa-plus"></i> 新增學習計劃</button>
             <button onclick="generatePlan()" data-i18n="generatePlanBtn"><i class="fa-solid fa-bolt"></i> 產生記憶計劃</button>
          </div>

          <div id="plan-container">
            </div>
        </div>
        
        <div class="main">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
              <label style="display: flex; align-items: center; width: auto; cursor: pointer;">
                <input type="checkbox" id="selectAllDays" onchange="toggleAllCheckboxes()" style="width: auto; margin: 0 8px 0 0;">
                <span data-i18n-id="selectAllDays">全選日期</span>
              </label>
          </div>

          <div id="calendar"></div>
        </div>
      </div>
    </div> 
    
    <footer class="app-footer">
        WEI-YEN,CHANG © 2026 All Rights Reserved.
        <div class="visit-counter">
            <i class="fa-solid fa-users"></i> <span data-i18n-id="visitCountLabel">使用人次</span>: <span id="visitor-count">1,024</span>
        </div>
    </footer>
  </div> 
    
    <script>
    const weekdayMap = ['日', '一', '二', '三', '四', '五', '六'];
    const weekdayMap_en = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    // Default fallback colors
    const defaultColors = ['#E3F2FD', '#F3E5F5', '#E8F5E9', '#FFF3E0', '#FBE9E7', '#E0F2F1'];
    
    let latestPlan = {};
    let allPlansData = {}; 
    let planCount = 0;
    let planColors = {}; 
    let currentLang = 'zh'; 

    const translations = {
      zh: {
        pageTitle: '學習計劃表產生器',
        mainHeader: '學習計劃表產生器',
        headerSubtitle: 'A Breeze to Plan, A Joy to Learn.',
        toggleThemeBtn: '夜間', 
        toggleLangBtn: '中文/EN',
        addPlanBtn: '新增任務',
        generatePlanBtn: '產生計劃',
        downloadGCcsv: '下載 CSV',
        checklistBtnLabel: '下載追蹤檢核表',
        openGoogleSheetBtn: '使用 Google Sheet 建立',
        downloadExcelBtn: '下載 Excel (.xlsx)',
        importBtnLabel: '匯入 / 匯出計劃設定',
        selectAllDays: '全選日期', 
        addToCalendarBtnText: '加入行事曆', 
        gcTitleSettingLabel: '任務顯示設定:', 
        mergePlansLabel: '合併顯示',
        separatePlansLabel: '獨立顯示',
        backupRestoreLabel: '設定檔 備份/還原:',
        exportSettingsBtn: '匯出設定 CSV',
        importSettingsBtn: '匯入設定 CSV',
        planHeader: '任務', 
        titleLabel: '計劃名稱：',
        colorLabel: '標籤顏色',
        paletteLabel: 'AI 配色建議 (點擊套用)',
        applyAllBtn: '✨ 套用',
        shuffleBtnTitle: '換一組配色',
        randomColorBtn: '隨機',
        unitLabel: '任務名稱',
        startDateLabel: '開始日',
        endDateLabel: '結束日 (選填)',
        executionDatesLabel: '指定特定執行日期', 
        executionDatesPlaceholder: '用逗號或換行分隔 M/D 或 YYYY/M/D',
        excludeDaysLabel: '排除星期',
        weekdaySun: '日', weekdayMon: '一', weekdayTue: '二', weekdayWed: '三', weekdayThu: '四', weekdayFri: '五', weekdaySat: '六',
        excludeDatesLabel: '指定排除日',
        excludeDatesPlaceholder: '用逗號或換行分隔 M/D 或 YYYY/M/D',
        rangeLabel: '任務範圍',
        rangeTypePages: '頁數',
        rangeTypeOutline: '大綱',
        pageRangeLabel: '頁數範圍 (ex. 19~25)',
        outlineLabel: '任務清單/大綱',
        outlinePlaceholder: '主題一,主題二,主題三',
        dailyAmountLabel: '單次執行量',
        requiredDaysLabel: '預估天數', 
        reverseOrder: '逆序',
        showContentLabel: '執行動作',
        showStudy: '學習',
        showReview: '複習',
        showCustom: '自訂', 
        customTextLabel: '自訂文字', 
        customTextPlaceholder: '例如：Task', 
        deleteBtn: '刪除',
        studyText: '學習',
        reviewText: '複習',
        visitCountLabel: '使用人次',
      },
      en: {
        pageTitle: 'Simple Plan Builder',
        mainHeader: 'Simple Plan Builder',
        headerSubtitle: 'A Breeze to Plan, A Joy to Learn.',
        toggleThemeBtn: 'Dark', 
        toggleLangBtn: 'ZH/EN',
        addPlanBtn: 'Add Task',
        generatePlanBtn: 'Generate',
        downloadGCcsv: 'Download Google Calendar CSV',
        checklistBtnLabel: 'Download Progress Tracker',
        openGoogleSheetBtn: 'Create in Google Sheets',
        downloadExcelBtn: 'Download Excel (.xlsx)',
        importBtnLabel: 'Import / Export Plan Settings',
        selectAllDays: 'Select All', 
        addToCalendarBtnText: 'Add to Calendar', 
        gcTitleSettingLabel: 'Display Settings:',
        mergePlansLabel: 'Merge Tasks',
        separatePlansLabel: 'Separate Tasks',
        backupRestoreLabel: 'Config Backup / Restore:',
        exportSettingsBtn: 'Export Settings CSV',
        importSettingsBtn: 'Import Settings CSV',
        planHeader: 'Task', 
        titleLabel: 'Plan Name:',
        colorLabel: 'Color Tag',
        paletteLabel: 'Smart Palette',
        applyAllBtn: '✨ Apply',
        shuffleBtnTitle: 'Shuffle Palette',
        randomColorBtn: 'Reset',
        unitLabel: 'Task Name/Unit',
        startDateLabel: 'Start Date',
        endDateLabel: 'End Date (Optional)',
        executionDatesLabel: 'Specific Dates', 
        executionDatesPlaceholder: 'e.g. 11/23, 11/25',
        excludeDaysLabel: 'Exclude Days',
        weekdaySun: 'Sun', weekdayMon: 'Mon', weekdayTue: 'Tue', weekdayWed: 'Wed', weekdayThu: 'Thu', weekdayFri: 'Fri', weekdaySat: 'Sat',
        excludeDatesLabel: 'Exclude Dates',
        excludeDatesPlaceholder: 'e.g. 7/22, 12/25',
        rangeLabel: 'Scope',
        rangeTypePages: 'Pages',
        rangeTypeOutline: 'Outline',
        pageRangeLabel: 'Range (e.g. 19~25)',
        outlineLabel: 'Outline (comma separated)',
        outlinePlaceholder: 'Topic 1, Topic, Topic 3',
        dailyAmountLabel: 'Amount Per Execution',
        requiredDaysLabel: 'Est. Days', 
        reverseOrder: 'Reverse',
        showContentLabel: 'Actions',
        showStudy: 'Study',
        showReview: 'Review',
        showCustom: 'Custom',
        customTextLabel: 'Custom Text',
        customTextPlaceholder: 'e.g. Task',
        deleteBtn: 'Delete',
        studyText: 'Study',
        reviewText: 'Review',
        visitCountLabel: 'Visits',
      }
    };

    function getRandomColor() {
      return defaultColors[Math.floor(Math.random() * defaultColors.length)];
    }

    // --- Toggle Mobile Menu ---
    function toggleMobileMenu() {
        const menu = document.getElementById('mobileMenu');
        menu.classList.toggle('active');
    }

    // --- Dropdown Logic ---
    function toggleDropdown(id) {
        // Close all other dropdowns first
        const dropdowns = document.getElementsByClassName("dropdown-content");
        for (let i = 0; i < dropdowns.length; i++) {
            if(dropdowns[i].id !== id) {
                dropdowns[i].classList.remove('show');
            }
        }
        document.getElementById(id).classList.toggle("show");
    }

    // Close dropdowns if clicked outside
    window.onclick = function(event) {
        if (!event.target.matches('.dropdown-btn') && !event.target.closest('.dropdown-btn')) {
            const dropdowns = document.getElementsByClassName("dropdown-content");
            for (let i = 0; i < dropdowns.length; i++) {
                const openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show') && !event.target.closest('.dropdown-content')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
        // Also close mobile menu if clicked outside header
        if (!event.target.closest('.header-main')) {
            const menu = document.getElementById('mobileMenu');
            if (menu && menu.classList.contains('active')) {
                menu.classList.remove('active');
            }
        }
    }

    // --- Helper to parse Weight ---
    function parseWeight(str) {
        const match = str.match(/^(.*?)\[(\d+)\]$/);
        if (match) {
            return { text: match[1].trim(), weight: parseInt(match[2]) };
        }
        return { text: str.trim(), weight: 1 };
    }

    // --- COLOR HARMONY GENERATOR ALGORITHM ---
    function hslToHex(h, s, l) {
        l /= 100;
        const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
    }

    function generateHarmoniousPalette(isDarkMode) {
        const baseHue = Math.floor(Math.random() * 360);
        let sRange, lRange;
        if (isDarkMode) {
            sRange = [70, 100]; 
            lRange = [60, 80];  
        } else {
            sRange = [60, 90];  
            lRange = [70, 90];  
        }
        
        const getSL = () => {
            const s = Math.floor(Math.random() * (sRange[1] - sRange[0])) + sRange[0];
            const l = Math.floor(Math.random() * (lRange[1] - lRange[0])) + lRange[0];
            return {s, l};
        };

        const rules = ['analogous', 'complementary', 'triadic', 'split-complementary', 'monochromatic'];
        const rule = rules[Math.floor(Math.random() * rules.length)];
        
        const colors = [];
        let hues = [];

        switch(rule) {
            case 'analogous': hues = [baseHue, baseHue + 30, baseHue + 60, baseHue - 30, baseHue - 60]; break;
            case 'complementary': hues = [baseHue, baseHue, baseHue + 180, baseHue + 180, baseHue]; break;
            case 'triadic': hues = [baseHue, baseHue + 120, baseHue + 240, baseHue + 120, baseHue + 240]; break;
            case 'split-complementary': hues = [baseHue, baseHue + 150, baseHue + 210, baseHue + 150, baseHue + 210]; break;
            case 'monochromatic': hues = [baseHue, baseHue, baseHue, baseHue, baseHue]; break;
        }

        for (let i = 0; i < 5; i++) {
            let h = (hues[i] + 360) % 360; 
            let {s, l} = getSL();
            if (rule === 'monochromatic' || rule === 'complementary') {
                l = l - (i * 10) + 20; 
                if (l > 95) l = 95;
                if (l < 40) l = 40;
            }
            colors.push(hslToHex(h, s, l));
        }
        return colors; 
    }
    
    function applyPaletteToAll(paletteColors) {
        const allIds = Object.keys(allPlansData).map(Number).sort((a,b) => a-b);
        if (allIds.length === 0) return;

        allIds.forEach((planId, index) => {
            const color = paletteColors[index % paletteColors.length];
            if (allPlansData[planId]) {
                allPlansData[planId].color = color;
            }
            planColors[planId] = color; 
            const picker = document.getElementById(`colorPicker-${planId}`);
            if (picker) picker.value = color;
            const group = document.querySelector(`.plan-group[data-id="${planId}"]`);
            if (group) group.style.borderLeft = `5px solid ${color}`;
            savePlanData(planId);
        });
        generatePlan();
    }

    function renderPaletteSuggestions(id) {
        const container = document.getElementById(`palette-grid-${id}`);
        if(!container) return;
        
        container.innerHTML = ''; 
        const isDark = document.body.classList.contains('dark-mode');
        const palette = generateHarmoniousPalette(isDark);
        
        const headerContainer = document.getElementById(`palette-header-${id}`);
        if (headerContainer) {
            headerContainer.innerHTML = '';
            const labelSpan = document.createElement('span');
            labelSpan.textContent = translations[currentLang].paletteLabel;
            
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'palette-controls';
            
            const shuffleBtn = document.createElement('button');
            shuffleBtn.className = 'palette-btn';
            shuffleBtn.title = translations[currentLang].shuffleBtnTitle;
            shuffleBtn.innerHTML = '<i class="fa-solid fa-rotate"></i>';
            shuffleBtn.onclick = () => renderPaletteSuggestions(id);
            
            const applyBtn = document.createElement('button');
            applyBtn.className = 'palette-btn apply-all';
            applyBtn.textContent = translations[currentLang].applyAllBtn;
            applyBtn.onclick = () => applyPaletteToAll(palette); 
            
            controlsDiv.appendChild(shuffleBtn);
            controlsDiv.appendChild(applyBtn);
            headerContainer.appendChild(labelSpan);
            headerContainer.appendChild(controlsDiv);
        }

        const row = document.createElement('div');
        row.className = 'palette-row';
        palette.forEach(color => {
            const swatch = document.createElement('div');
            swatch.className = 'palette-swatch';
            swatch.style.backgroundColor = color;
            swatch.title = color;
            row.appendChild(swatch);
        });
        container.appendChild(row);
    }

    // --- IMPORT / EXPORT LOGIC ---

    function exportPlanSettingsCSV() {
        if (Object.keys(allPlansData).length === 0) {
            alert(currentLang === 'zh' ? '沒有計畫可匯出' : 'No plans to export');
            return;
        }

        // Define Headers
        const headers = [
            "id", "color", "unit", "startDate", "endDate", 
            "executionDates", "useExecutionDates", 
            "excludeWeekdays", "excludeDates", "useExcludeDates",
            "rangeType", "dailyAmount", "pageRange", "outline",
            "reverseOrder", "showStudy", "showReview", "showCustom", "customText"
        ];

        let csvContent = headers.join(",") + "\n";

        Object.values(allPlansData).forEach(plan => {
            let row = [];
            
            // Helper to escape commas and quotes in CSV
            const safe = (val) => {
                if (val === null || val === undefined) return "";
                const str = String(val);
                // If contains comma, quote, or newline, wrap in quotes and escape quotes
                if (str.includes(",") || str.includes("\"") || str.includes("\n")) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            row.push(plan.id);
            row.push(plan.color);
            row.push(safe(plan.unit));
            row.push(plan.startDate);
            row.push(plan.endDate);
            row.push(safe(plan.executionDates)); // encode/safe newlines
            row.push(plan.useExecutionDates);
            row.push(safe(plan.excludeWeekdays.join("|"))); // Join array with pipe
            row.push(safe(plan.excludeDates));
            row.push(plan.useExcludeDates);
            row.push(plan.rangeType);
            row.push(plan.dailyAmount);
            row.push(safe(plan.pageRange));
            row.push(safe(plan.outline)); // Outline likely contains commas
            row.push(plan.reverseOrder);
            row.push(plan.showStudy);
            row.push(plan.showReview);
            row.push(plan.showCustom);
            row.push(safe(plan.customText));

            csvContent += row.join(",") + "\n";
        });

        // Add BOM (\uFEFF) to fix Excel encoding
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `plan_config_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function handleImportFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            parseSettingsCSV(text);
            input.value = ''; // Reset input
        };
        reader.readAsText(file);
    }

    function parseSettingsCSV(text) {
        // Clear current plans
        allPlansData = {};
        planColors = {};
        planCount = 0;
        document.getElementById('plan-container').innerHTML = '';

        // Normalize line endings
        text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        // Robust CSV Parser (State Machine)
        const rows = [];
        let currentRow = [];
        let currentCell = '';
        let inQuote = false;

        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i+1];

            if (char === '"') {
                if (inQuote && nextChar === '"') {
                    currentCell += '"'; // Escaped quote
                    i++; 
                } else {
                    inQuote = !inQuote; // Toggle quote
                }
            } else if (char === ',' && !inQuote) {
                currentRow.push(currentCell);
                currentCell = '';
            } else if (char === '\n' && !inQuote) {
                currentRow.push(currentCell);
                if (currentRow.length > 0) rows.push(currentRow);
                currentRow = [];
                currentCell = '';
            } else {
                currentCell += char;
            }
        }
        // Push last cell
        if (currentCell || currentRow.length > 0) {
            currentRow.push(currentCell);
            rows.push(currentRow);
        }

        if (rows.length < 2) return; // Only header or empty

        // Skip header (index 0)
        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i];
            
            // Check if row has enough columns (at least id and color)
            if (cols.length < 2) continue;

            const id = parseInt(cols[0]) || 0;
            const planData = {
                id: id,
                color: cols[1],
                unit: cols[2],
                startDate: cols[3],
                endDate: cols[4],
                executionDates: cols[5],
                useExecutionDates: cols[6] === 'true',
                excludeWeekdays: cols[7] ? cols[7].split('|').map(Number) : [],
                excludeDates: cols[8],
                useExcludeDates: cols[9] === 'true',
                rangeType: cols[10],
                dailyAmount: parseInt(cols[11]) || 1,
                pageRange: cols[12],
                outline: cols[13],
                reverseOrder: cols[14] === 'true',
                showStudy: cols[15] === 'true',
                showReview: cols[16] === 'true',
                showCustom: cols[17] === 'true',
                customText: cols[18],
                isCollapsed: false
            };

            allPlansData[id] = planData;
            planColors[id] = planData.color;
            if (id >= planCount) planCount = id + 1;

            addPlan(planData, id);
        }

        generatePlan();
    }

    // --- NEW: OPEN IN GOOGLE SHEETS (VIA CLIPBOARD HTML) ---
    function openInGoogleSheets() {
        if (Object.keys(latestPlan).length === 0) {
            alert(currentLang === 'zh' ? '目前沒有產生任何計畫資料' : 'No generated plan data available');
            return;
        }

        // 1. Prepare Data (HTML Table Format for Rich Paste)
        const sortedDates = Object.keys(latestPlan).sort();
        if (sortedDates.length === 0) return;
        
        const minDate = new Date(sortedDates[0]);
        const maxDate = new Date(sortedDates[sortedDates.length - 1]);
        
        // Generate Dates
        const timelineDates = [];
        const timelineWeekdays = [];
        const dateIterator = new Date(minDate);
        while (dateIterator <= maxDate) {
            const dateStr = getDateStr(dateIterator).replace(/-/g, '/');
            timelineDates.push(dateStr);
            const wd = currentLang === 'zh' ? weekdayMap[dateIterator.getDay()] : weekdayMap_en[dateIterator.getDay()];
            timelineWeekdays.push(wd);
            dateIterator.setDate(dateIterator.getDate() + 1);
        }

        // Build HTML String with Arial Font
        let html = '<html xmlns:x="urn:schemas-microsoft-com:office:excel">';
        html += '<head><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/></head>';
        html += '<body><table border="1" style="font-family: Arial, sans-serif;">';

        // Row 0: Dates starting at L (Index 11) - Wait, Timeline Starts at K (Index 10)
        
        html += '<tr>';
        for(let i=0; i<11; i++) html += '<td></td>'; // 11 Empty Cells (A-K reserved for data/chart, wait... K is Chart)
        // A:Color, B:Plan, C:Start, D:End, E:Actual, F:Task, G:Status, H:Done, I:Total, J:Rate, K:Chart
        // So timeline starts at L (12th column, index 11).
        
        timelineDates.forEach(d => html += `<td style="background-color:#EFEFEF; font-weight:bold; text-align:center;">${d}</td>`);
        html += '</tr>';
        
        // Row 1: Headers
        const headers = [
            "Color", "計畫名稱 (Plan)", "開始時間 (Start)", "結束時間 (End)", "實際完成日 (Actual)", 
            "任務內容 (Task)", "任務狀態 (Status)", "已完成數量 (Done)", "任務總數 (Total)", 
            "完成率 (Rate)", "完成率圖 (Chart)"
        ];
        html += '<tr>';
        headers.forEach(h => html += `<td style="font-weight:bold; background-color:#E0E0E0;">${h}</td>`);
        timelineWeekdays.forEach(w => html += `<td style="background-color:#F5F5F5; text-align:center;">${w}</td>`);
        html += '</tr>';

        // Data Rows
        let rowCounter = 2; // Starting data row (Excel row 3)

        sortedDates.forEach(dateStr => {
            const tasks = latestPlan[dateStr];
            tasks.forEach(task => {
                const planInfo = allPlansData[task.planId];
                const planName = planInfo && planInfo.unit ? planInfo.unit : `Plan #${task.planId}`;
                const formattedDateStr = dateStr.replace(/-/g, '/');
                const color = planInfo ? planInfo.color : "#CCCCCC";
                const excelRow = rowCounter + 1; // 1-based index for formulas

                html += '<tr>';
                
                // A: Color
                html += `<td style="background-color:${color};"></td>`;
                
                // B-E
                html += `<td>${planName}</td>`;
                html += `<td>${formattedDateStr}</td>`;
                html += `<td>${formattedDateStr}</td>`;
                html += `<td></td>`;
                
                // F: Task
                html += `<td>${task.text}</td>`;
                
                // G: Status
                html += `<td>Not Start</td>`;
                
                // H: Done
                html += `<td>0</td>`;
                
                // I: Total
                html += `<td>1</td>`;
                
                // J: Rate Formula
                html += `<td>=H${excelRow}/I${excelRow}</td>`;
                
                // K: Chart Formula
                html += `<td>=SPARKLINE(H${excelRow}:I${excelRow},{"charttype","bar";"max",1;"color1","#FFBC5A";"color2","wheat"})</td>`;

                // L+: Timeline (Color Background)
                // Use Conditional Logic in HTML? No, Google Sheets pastes static style.
                // But user wants "background color". 
                // We can set background color IF the date matches.
                timelineDates.forEach((tDate, idx) => {
                   const colIdx = 11 + idx; // Start at L
                   const colLetter = XLSX.utils.encode_col(colIdx);
                   // Dynamic Formula for Gantt
                   // Font color is plan color
                   const f = `=IF(AND(${colLetter}$1>=$C${excelRow}, ${colLetter}$1<=$D${excelRow}), "■", "")`;
                   html += `<td style="color:${color}; font-weight:900; text-align:center;">${f}</td>`;
                });

                html += '</tr>';
                rowCounter++;
            });
        });

        html += '</table></body></html>';

        // 2. Copy to Clipboard
        const blob = new Blob([html], { type: "text/html" });
        const data = [new ClipboardItem({ "text/html": blob })];

        navigator.clipboard.write(data).then(() => {
            const msg = currentLang === 'zh' 
                ? "✅ 資料已複製到剪貼簿！\n\n即將開啟 Google Sheets，請在建立新試算表後按下 [Ctrl + V] 貼上。" 
                : "✅ Data copied to clipboard!\n\nOpening Google Sheets... Please press [Ctrl + V] to paste into the new sheet.";
            alert(msg);
            window.open("https://sheets.new", "_blank");
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert("Copy failed. Please use the Download Excel option.");
        });
    }

    // --- EXISTING: EXCEL CHECKLIST DOWNLOAD FUNCTION (UPDATED) ---
    function downloadExcelChecklist() {
        if (Object.keys(latestPlan).length === 0) {
            alert(currentLang === 'zh' ? '目前沒有產生任何計畫資料' : 'No generated plan data available');
            return;
        }

        // 1. Calculate Date Range for Timeline
        const sortedDates = Object.keys(latestPlan).sort();
        if (sortedDates.length === 0) return;
        
        const minDate = new Date(sortedDates[0]);
        const maxDate = new Date(sortedDates[sortedDates.length - 1]);
        
        const timelineDates = [];
        const timelineWeekdays = [];
        const dateIterator = new Date(minDate);
        while (dateIterator <= maxDate) {
            const dateStr = getDateStr(dateIterator).replace(/-/g, '/'); 
            timelineDates.push(dateStr);
            const wd = currentLang === 'zh' ? weekdayMap[dateIterator.getDay()] : weekdayMap_en[dateIterator.getDay()];
            timelineWeekdays.push(wd);
            dateIterator.setDate(dateIterator.getDate() + 1);
        }

        // 2. Prepare Data Rows
        const dataRows = [];
        
        // Header Row 1 (Titles)
        const headers = [
            { v: "Color", s: { font: { bold: true, name: "Arial" } } },
            { v: "計畫名稱 (Plan)", s: { font: { bold: true, name: "Arial" } } },
            { v: "開始時間 (Start)", s: { font: { bold: true, name: "Arial" } } },
            { v: "結束時間 (End)", s: { font: { bold: true, name: "Arial" } } },
            { v: "實際完成日 (Actual)", s: { font: { bold: true, name: "Arial" } } },
            { v: "任務內容 (Task)", s: { font: { bold: true, name: "Arial" } } },
            { v: "任務狀態 (Status)", s: { font: { bold: true, name: "Arial" } } },
            { v: "已完成數量 (Done)", s: { font: { bold: true, name: "Arial" } } },
            { v: "任務總數 (Total)", s: { font: { bold: true, name: "Arial" } } },
            { v: "完成率 (Rate)", s: { font: { bold: true, name: "Arial" } } },
            { v: "完成率圖 (Chart)", s: { font: { bold: true, name: "Arial" } } }
        ];
        
        // Row 0: Date Headers starting at L (Index 11)
        const row0 = new Array(11).fill("");
        timelineDates.forEach(d => row0.push({ v: d, s: { font: { name: "Arial" }, alignment: { horizontal: "center" } } }));
        
        // Row 1: Column Titles + Weekdays
        const row1 = [...headers];
        timelineWeekdays.forEach(w => row1.push({ v: w, s: { font: { name: "Arial" }, alignment: { horizontal: "center" } } }));
        
        dataRows.push(row0);
        dataRows.push(row1);

        // 3. Populate Tasks
        sortedDates.forEach(dateStr => {
            const tasks = latestPlan[dateStr];
            
            tasks.forEach(task => {
                const planInfo = allPlansData[task.planId];
                const planName = planInfo && planInfo.unit ? planInfo.unit : `Plan #${task.planId}`;
                const formattedDateStr = dateStr.replace(/-/g, '/');
                const color = planInfo ? planInfo.color : "#CCCCCC";
                const fgColor = color.replace('#', '');

                const rowIndex = dataRows.length + 1;

                const row = [
                    { v: "", s: { fill: { fgColor: { rgb: fgColor } } } }, // A: Color
                    { v: planName, s: { font: { name: "Arial" } } },
                    { v: formattedDateStr, s: { font: { name: "Arial" } } },
                    { v: formattedDateStr, s: { font: { name: "Arial" } } },
                    { v: "", s: { font: { name: "Arial" } } },
                    { v: task.text, s: { font: { name: "Arial" } } },
                    { v: "Not Start", s: { font: { name: "Arial" } } }, // Dropdown (Simulated via Text)
                    { v: 0, s: { font: { name: "Arial" } } },
                    { v: 1, s: { font: { name: "Arial" } } },
                    { t: 'n', f: `H${rowIndex}/I${rowIndex}`, z: '0%', s: { font: { name: "Arial" } } }, 
                    // Chart: REPT formula
                    { t: 's', f: `REPT("█",H${rowIndex}/I${rowIndex}*20)&REPT("░",20-H${rowIndex}/I${rowIndex}*20)`, s: { font: { name: "Arial", color: { rgb: "FFBC5A" } } } }
                ];
                
                // Dynamic Timeline with Formula + Colored Text
                const timelineCells = timelineDates.map((tDate, idx) => {
                    const colIdx = 11 + idx; // Start at L
                    const colLetter = XLSX.utils.encode_col(colIdx);
                    
                    // Formula to check date range against C and D
                    const f = `IF(AND(${colLetter}$1>=$C${rowIndex}, ${colLetter}$1<=$D${rowIndex}), "■", "")`;
                    
                    return { t: 's', f: f, s: { font: { name: "Arial", color: { rgb: fgColor }, sz: 14, bold: true }, alignment: { horizontal: "center" } } };
                });

                dataRows.push(row.concat(timelineCells));
            });
        });

        // 4. Create Workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(dataRows);

        // Set Col Widths
        const wscols = [
            {wch:5},  // Color
            {wch:20}, {wch:12}, {wch:12}, {wch:15}, {wch:40}, 
            {wch:15}, {wch:10}, {wch:10}, {wch:10}, {wch:20}
        ];
        timelineDates.forEach(() => wscols.push({wch:4}));
        ws['!cols'] = wscols;

        XLSX.utils.book_append_sheet(wb, ws, "Checklist");
        const today = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `Learning_Checklist_${today}.xlsx`);
    }

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }
    function getDateStr(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function parseDateInputToYYYYMMDD(dateStr, referenceYear) {
        dateStr = dateStr.trim();
        const parts = dateStr.split(/[\/-]/).filter(Boolean).map(s => s.trim());
        let y, m, d;
        if (parts.length === 2) { 
            m = parseInt(parts[0], 10);
            d = parseInt(parts[1], 10);
            y = referenceYear;
        } else if (parts.length === 3) { 
            if (parts[0].length === 4) {
                y = parseInt(parts[0], 10);
                m = parseInt(parts[1], 10);
                d = parseInt(parts[2], 10);
            } else if (parts[2].length === 4) { 
                y = parseInt(parts[2], 10);
                m = parseInt(parts[0], 10);
                d = parseInt(parts[1], 10);
            } else { return null; }
        } else { return null; }
        if (isNaN(y) || isNaN(m) || isNaN(d) || m < 1 || m > 12 || d < 1 || d > 31) return null;
        const date = new Date(y, m - 1, d);
        if (date.getFullYear() !== y || date.getMonth() !== m - 1 || date.getDate() !== d) return null;
        return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    }

    function isExcluded(date, excludeWeekdays, excludeDates) {
        const dayOfWeek = date.getDay();
        const dateStr = getDateStr(date);
        return excludeWeekdays.includes(dayOfWeek) || excludeDates.includes(dateStr);
    }
    
    // --- UPDATED CORE LOGIC: Optimized Range String (Handling duplicate items) ---
    function getRangeString(items) {
        if (!items || items.length === 0) return '';
        
        // Remove consecutive duplicates for the display string (Example 1: 20,20,20,20 -> 20)
        const uniqueSequence = [];
        items.forEach((item, idx) => {
            if (idx === 0 || item !== items[idx - 1]) {
                uniqueSequence.push(item);
            }
        });

        const isAllNumeric = uniqueSequence.every(item => /^\d+$/.test(item));
        if (isAllNumeric && uniqueSequence.length > 1) {
            const nums = uniqueSequence.map(Number);
            // Check if sequential
            let isConsecutive = true;
            for (let i = 0; i < nums.length - 1; i++) {
                if (nums[i] + 1 !== nums[i + 1] && nums[i] - 1 !== nums[i + 1]) {
                    isConsecutive = false;
                    break;
                }
            }
            if (isConsecutive) return `${uniqueSequence[0]}~${uniqueSequence[uniqueSequence.length - 1]}`;
        }
        return uniqueSequence.join(',');
    }
    
    function updateRequiredDays(id) {
        const dailyAmountInput = document.getElementById(`dailyAmount-${id}`);
        const requiredDaysSpan = document.getElementById(`requiredDays-${id}`);
        if (!dailyAmountInput || !requiredDaysSpan) return;
        const totalRange = getTaskRange(id);
        const dailyAmount = parseInt(dailyAmountInput.value);
        let requiredDays = '-';
        if (totalRange > 0 && dailyAmount > 0 && !isNaN(dailyAmount)) {
            requiredDays = Math.ceil(totalRange / dailyAmount);
            requiredDays = requiredDays + (currentLang === 'zh' ? ' 天' : ' Days');
        }
        requiredDaysSpan.textContent = requiredDays;
    }
    
    function getTaskRange(id) {
        const items = getItemsArray(id);
        return items.length;
    }

    // --- UPDATED CORE LOGIC: Parsing Weight [n] ---
    function getItemsArray(id) {
        let items = [];
        const rangeType = document.querySelector(`input[name="rangeType-${id}"]:checked`)?.value || 'pages';
        const reverse = document.getElementById(`reverseOrder-${id}`)?.checked || false;
        
        if (rangeType === 'pages') {
            const pageRangeInput = document.getElementById(`pageRange-${id}`);
            if (!pageRangeInput) return [];
            const rawParts = pageRangeInput.value.split(',').map(s => s.trim()).filter(s => s);
            
            rawParts.forEach(part => {
                const { text, weight } = parseWeight(part);
                const rangeMatch = text.match(/^(\d+)~(\d+)$/);
                if (rangeMatch) {
                    let start = parseInt(rangeMatch[1]);
                    let end = parseInt(rangeMatch[2]);
                    if (start > end) [start, end] = [end, start];
                    for (let i = start; i <= end; i++) {
                        for (let w = 0; w < weight; w++) items.push(String(i));
                    }
                } else if (/^\d+$/.test(text)) {
                    for (let w = 0; w < weight; w++) items.push(text);
                }
            });
        } else {
            const outlineInput = document.getElementById(`outline-${id}`);
            if (!outlineInput) return [];
            const rawParts = outlineInput.value.split(',').map(s => s.trim()).filter(s => s);
            rawParts.forEach(part => {
                const { text, weight } = parseWeight(part);
                for (let w = 0; w < weight; w++) items.push(text);
            });
        }
        return reverse ? items.reverse() : items;
    }

    // --- MODIFIED: NO PERSISTENCE ---
    function loadPlansData() {
        // Originally loaded from localStorage. Now initializes empty.
        allPlansData = {};
        planCount = 0;
    }

    function savePlanData(id) {
        const planGroup = document.querySelector(`.plan-group[data-id="${id}"]`);
        if (!planGroup) return;

        const colorPicker = document.getElementById(`colorPicker-${id}`);
        const unitInput = document.getElementById(`unit-${id}`);
        const startDateInput = document.getElementById(`startDate-${id}`);
        const endDateInput = document.getElementById(`endDate-${id}`);
        const executionDatesInput = document.getElementById(`executionDates-${id}`);
        const useExecutionDatesCheckbox = document.getElementById(`useExecutionDatesCheckbox-${id}`);
        const excludeDatesInput = document.getElementById(`excludeDates-${id}`);
        const excludeCustomDatesCheckbox = document.getElementById(`excludeCustomDates-${id}`);
        const dailyAmountInput = document.getElementById(`dailyAmount-${id}`);
        const pageRangeInput = document.getElementById(`pageRange-${id}`);
        const outlineInput = document.getElementById(`outline-${id}`);
        const reverseOrderCheckbox = document.getElementById(`reverseOrder-${id}`);
        const showStudyCheckbox = document.getElementById(`showStudy-${id}`);
        const showReviewCheckbox = document.getElementById(`showReview-${id}`);
        const showCustomCheckbox = document.getElementById(`showCustomCheckbox-${id}`);
        const customTextInput = document.getElementById(`customText-${id}`);
        
        const rangeType = document.querySelector(`input[name="rangeType-${id}"]:checked`)?.value || 'pages';

        let excludeWeekdays = [];
        for (let i = 0; i < 7; i++) {
            if (document.getElementById(`excludeWeekday-${id}-${i}`)?.checked) excludeWeekdays.push(i);
        }

        const planData = {
            id: id,
            color: colorPicker ? colorPicker.value : '',
            unit: unitInput ? unitInput.value.trim() : '',
            startDate: startDateInput ? startDateInput.value : '',
            endDate: endDateInput ? endDateInput.value : '',
            executionDates: executionDatesInput ? executionDatesInput.value.trim() : '',
            useExecutionDates: useExecutionDatesCheckbox ? useExecutionDatesCheckbox.checked : false,
            excludeWeekdays: excludeWeekdays,
            excludeDates: excludeDatesInput ? excludeDatesInput.value.trim() : '',
            useExcludeDates: excludeCustomDatesCheckbox ? excludeCustomDatesCheckbox.checked : false,
            rangeType: rangeType,
            dailyAmount: dailyAmountInput ? parseInt(dailyAmountInput.value) : 1,
            pageRange: pageRangeInput ? pageRangeInput.value.trim() : '',
            outline: outlineInput ? outlineInput.value.trim() : '',
            reverseOrder: reverseOrderCheckbox ? reverseOrderCheckbox.checked : false,
            showStudy: showStudyCheckbox ? showStudyCheckbox.checked : true,
            showReview: showReviewCheckbox ? showReviewCheckbox.checked : true,
            showCustom: showCustomCheckbox ? showCustomCheckbox.checked : false,
            customText: customTextInput ? customTextInput.value.trim() : '',
        };

        allPlansData[id] = planData;
        // REMOVED: localStorage.setItem('learningPlans', JSON.stringify(allPlansData));
    }

    function deletePlan(id) {
        if (!confirm(currentLang === 'zh' ? '確定要刪除這個計劃嗎？' : 'Are you sure you want to delete this plan?')) {
            return;
        }
        const planGroup = document.querySelector(`.plan-group[data-id="${id}"]`);
        if (planGroup) planGroup.remove();
        delete allPlansData[id];
        delete planColors[id];
        // REMOVED: localStorage.setItem('learningPlans', JSON.stringify(allPlansData));
        generatePlan();
    }

    function renderPlans() {
        const container = document.getElementById('plan-container');
        if (!container) return;
        container.innerHTML = '';
        Object.values(allPlansData).forEach(planData => {
            addPlan(planData, planData.id);
        });
    }

    function addPlan(planData = null, id = null) {
        const headerText = translations[currentLang].planHeader;
        id = id === null ? planCount++ : id;
        
        let colorValue;
        if (planColors[id]) colorValue = planColors[id];
        else if (planData && planData.color) colorValue = planData.color;
        else colorValue = getRandomColor();
        planColors[id] = colorValue; 

        const showStudy = planData === null || planData.showStudy === undefined ? true : planData.showStudy;
        const showReview = planData === null || planData.showReview === undefined ? true : planData.showReview;
        const showCustom = planData ? planData.showCustom : false;
        const customText = planData ? planData.customText : '';
        const isExecutionDatesUsed = planData ? planData.useExecutionDates : false;
        const isExcludeDatesCustomChecked = planData ? planData.useExcludeDates : false;
        const rangeType = planData ? planData.rangeType : 'pages';
        const container = document.getElementById('plan-container');
        
        const newPlanGroup = document.createElement('div');
        newPlanGroup.className = 'plan-group';
        newPlanGroup.dataset.id = id;
        newPlanGroup.style.borderLeft = `5px solid ${colorValue}`;

        newPlanGroup.innerHTML = `
            <div class="plan-header" onclick="togglePlanContent(${id})">
                <h3 id="plan-title-${id}" data-i18n="planHeader">${headerText} #${id}</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="toggle-icon" data-id="${id}">▲</span>
                    <button class="delete-btn" onclick="event.stopPropagation(); deletePlan(${id})" title="${translations[currentLang].deleteBtn}"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <div id="plan-content-${id}" class="plan-content" onchange="savePlanData(${id})">
                
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 12px;">
                    <label data-i18n-id="unitLabel" style="flex:1; margin-right:10px; margin-bottom:10px"><span>${translations[currentLang].unitLabel}</span>
                        <input id="unit-${id}" type="text" placeholder="" value="${planData ? planData.unit : ''}" oninput="updatePlanTitle(${id})">
                    </label>
                </div>

                <div style="margin-bottom:12px;">
                    <div class="color-label">
                        <label data-i18n-id="colorLabel" style="margin:0;"><span>${translations[currentLang].colorLabel}</span></label>
                        <div style="display:flex; align-items:center;">
                            <input id="colorPicker-${id}" class="color_picker" type="color" value="${colorValue}">
                            <button onclick="randomizeColor(${id})" data-i18n-id="randomColorBtn">${translations[currentLang].randomColorBtn}</button>
                        </div>
                    </div>
                    
                    <div class="palette-section">
                        <div id="palette-header-${id}" class="palette-header">
                             </div>
                        <div id="palette-grid-${id}" class="palette-grid">
                            </div>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <label style="flex:1;"><span data-i18n-id="startDateLabel">${translations[currentLang].startDateLabel}</span><input id="startDate-${id}" type="date" value="${planData ? planData.startDate : formatDate(new Date())}"></label>
                    <label style="flex:1;"><span data-i18n-id="endDateLabel">${translations[currentLang].endDateLabel}</span><input id="endDate-${id}" type="date" value="${planData ? planData.endDate : ''}"></label>
                </div>

                <label style="display: flex; align-items: center; margin-top: 5px; cursor: pointer;">
                    <input id="useExecutionDatesCheckbox-${id}" type="checkbox" ${isExecutionDatesUsed ? 'checked' : ''} onchange="toggleExecutionDatesInput(${id})" style="width: auto; margin: 0 5px 0 0;">
                    <span data-i18n-id="executionDatesLabel">${translations[currentLang].executionDatesLabel}</span>
                </label>
                
                <div id="executionDatesDiv-${id}" style="display: ${isExecutionDatesUsed ? 'block' : 'none'};">
                    <textarea id="executionDates-${id}" data-i18n-placeholder="executionDatesPlaceholder" placeholder="${translations[currentLang].executionDatesPlaceholder}">${planData ? planData.executionDates : ''}</textarea>
                </div>
                
                <label data-i18n-id="excludeDaysLabel" style="margin-top: 15px;">${translations[currentLang].excludeDaysLabel}</label>
                <div class="weekday-checkboxes">
                    <label><input id="excludeWeekday-${id}-0" type="checkbox" ${planData && planData.excludeWeekdays.includes(0) ? 'checked' : ''}><span data-i18n-id="weekdaySun">${translations[currentLang].weekdaySun}</span></label>
                    <label><input id="excludeWeekday-${id}-1" type="checkbox" ${planData && planData.excludeWeekdays.includes(1) ? 'checked' : ''}><span data-i18n-id="weekdayMon">${translations[currentLang].weekdayMon}</span></label>
                    <label><input id="excludeWeekday-${id}-2" type="checkbox" ${planData && planData.excludeWeekdays.includes(2) ? 'checked' : ''}><span data-i18n-id="weekdayTue">${translations[currentLang].weekdayTue}</span></label>
                    <label><input id="excludeWeekday-${id}-3" type="checkbox" ${planData && planData.excludeWeekdays.includes(3) ? 'checked' : ''}><span data-i18n-id="weekdayWed">${translations[currentLang].weekdayWed}</span></label>
                    <label><input id="excludeWeekday-${id}-4" type="checkbox" ${planData && planData.excludeWeekdays.includes(4) ? 'checked' : ''}><span data-i18n-id="weekdayThu">${translations[currentLang].weekdayThu}</span></label>
                    <label><input id="excludeWeekday-${id}-5" type="checkbox" ${planData && planData.excludeWeekdays.includes(5) ? 'checked' : ''}><span data-i18n-id="weekdayFri">${translations[currentLang].weekdayFri}</span></label>
                    <label><input id="excludeWeekday-${id}-6" type="checkbox" ${planData && planData.excludeWeekdays.includes(6) ? 'checked' : ''}><span data-i18n-id="weekdaySat">${translations[currentLang].weekdaySat}</span></label>
                </div>
                
                <label style="display: flex; align-items: center; margin-top: 15px; margin-bottom: 5px; cursor: pointer;">
                    <input id="excludeCustomDates-${id}" type="checkbox" ${isExcludeDatesCustomChecked ? 'checked' : ''} onchange="toggleExcludeDatesInput(${id})" style="width: auto; margin: 0 5px 0 0;">
                    <span data-i18n-id="excludeDatesLabel">${translations[currentLang].excludeDatesLabel}</span>
                </label>
                <div id="excludeDatesDiv-${id}" style="display: ${isExcludeDatesCustomChecked ? 'block' : 'none'};">
                    <textarea id="excludeDates-${id}" data-i18n-placeholder="excludeDatesPlaceholder" placeholder="${translations[currentLang].excludeDatesPlaceholder}">${planData ? planData.excludeDates : ''}</textarea>
                </div>

                <div style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                    <label data-i18n-id="rangeLabel" style="margin-bottom: 5px;">${translations[currentLang].rangeLabel}</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px;">
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input type="radio" name="rangeType-${id}" value="pages" ${rangeType === 'pages' ? 'checked' : ''} onchange="toggleRangeType(${id})"><span data-i18n-id="rangeTypePages">${translations[currentLang].rangeTypePages}</span></label>
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input type="radio" name="rangeType-${id}" value="outline" ${rangeType === 'outline' ? 'checked' : ''} onchange="toggleRangeType(${id})"><span data-i18n-id="rangeTypeOutline">${translations[currentLang].rangeTypeOutline}</span></label>
                    </div>

                    <div id="pageRangeDiv-${id}" style="display: ${rangeType === 'pages' ? 'block' : 'none'};">
                        <label data-i18n-id="pageRangeLabel"><span>${translations[currentLang].pageRangeLabel}</span>
                            <input id="pageRange-${id}" type="text" placeholder="ex. 19~25" value="${planData ? planData.pageRange : ''}" oninput="updateRequiredDays(${id})">
                        </label>
                    </div>

                    <div id="outlineDiv-${id}" style="display: ${rangeType === 'outline' ? 'block' : 'none'};">
                        <label data-i18n-id="outlineLabel"><span>${translations[currentLang].outlineLabel}</span>
                            <textarea id="outline-${id}" data-i18n-placeholder="outlinePlaceholder" placeholder="${translations[currentLang].outlinePlaceholder}" oninput="updateRequiredDays(${id})">${planData ? planData.outline : ''}</textarea>
                        </label>
                    </div>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <label data-i18n-id="dailyAmountLabel" style="flex:1;"><span>${translations[currentLang].dailyAmountLabel}</span>
                        <input id="dailyAmount-${id}" type="number" min="1" value="${planData ? planData.dailyAmount : 1}" oninput="updateRequiredDays(${id})">
                    </label>

                    <label data-i18n-id="requiredDaysLabel" style="flex:1;"><span>${translations[currentLang].requiredDaysLabel}</span>
                        <div style="padding: 12px; background: var(--bg-input); border-radius: var(--radius-md); text-align:center;">
                            <span id="requiredDays-${id}" style="font-weight: bold;">-</span>
                        </div>
                    </label>
                </div>

                <label style="display: flex; align-items: center; margin-top: 5px; cursor: pointer;">
                    <input id="reverseOrder-${id}" type="checkbox" ${planData && planData.reverseOrder ? 'checked' : ''} style="width: auto; margin: 0 5px 0 0;">
                    <span>${translations[currentLang].reverseOrder}</span>
                </label>

                <div style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                    <label data-i18n-id="showContentLabel" style="margin-bottom: 5px;">${translations[currentLang].showContentLabel}</label>
                    <div class="action-checkboxes" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px;">
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input id="showStudy-${id}" type="checkbox" ${showStudy ? 'checked' : ''}><span data-i18n-id="showStudy"> ${translations[currentLang].showStudy}</span></label>
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input id="showReview-${id}" type="checkbox" ${showReview ? 'checked' : ''}><span data-i18n-id="showReview"> ${translations[currentLang].showReview}</span></label>
                        <label style="margin:0; display:flex; flex-direction:row; gap:5px;"><input id="showCustomCheckbox-${id}" type="checkbox" ${showCustom ? 'checked' : ''} onchange="toggleCustomText(${id})"><span data-i18n-id="showCustom"> ${translations[currentLang].showCustom}</span></label>
                    </div>
                    <div id="customTextDiv-${id}" style="display: ${showCustom ? 'block' : 'none'};">
                        <label data-i18n-id="customTextLabel"><span>${translations[currentLang].customTextLabel}</span>
                            <input id="customText-${id}" type="text" data-i18n-placeholder="customTextPlaceholder" placeholder="${translations[currentLang].customTextPlaceholder}" value="${customText}">
                        </label>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newPlanGroup);

        updatePlanTitle(id);
        updateRequiredDays(id);

        // Render Initial Palette Suggestions
        renderPaletteSuggestions(id);

        document.getElementById(`colorPicker-${id}`).addEventListener('input', (e) => {
            const group = document.querySelector(`.plan-group[data-id="${id}"]`);
            group.style.borderLeft = `5px solid ${e.target.value}`;
            planColors[id] = e.target.value; 
            savePlanData(id);
        });

        if (planData && planData.isCollapsed) {
            const content = document.getElementById(`plan-content-${id}`);
            const icon = document.querySelector(`.plan-header .toggle-icon[data-id="${id}"]`);
            if (content && icon) {
                 content.classList.add('collapsed');
                 content.style.maxHeight = '0';
                 content.style.paddingTop = '0';
                 content.style.paddingBottom = '0';
                 content.style.overflow = 'hidden';
                 icon.textContent = '▼';
            }
        }
    }

    function togglePlanContent(id) {
        const content = document.getElementById(`plan-content-${id}`);
        const icon = document.querySelector(`.plan-header .toggle-icon[data-id="${id}"]`);
        if (content && icon) {
            const isCollapsed = content.classList.toggle('collapsed');
            if (isCollapsed) {
                 content.style.maxHeight = '0';
                 content.style.paddingTop = '0';
                 content.style.paddingBottom = '0';
                 content.style.overflow = 'hidden';
                 icon.textContent = '▼';
            } else {
                 content.style.maxHeight = '2000px'; 
                 content.style.paddingTop = '10px';
                 content.style.paddingBottom = '10px';
                 content.style.overflow = 'visible';
                 icon.textContent = '▲';
            }
            allPlansData[id].isCollapsed = isCollapsed;
            // REMOVED: localStorage.setItem('learningPlans', JSON.stringify(allPlansData));
        }
    }
    
    function toggleRangeType(id) {
        const pagesDiv = document.getElementById(`pageRangeDiv-${id}`);
        const outlineDiv = document.getElementById(`outlineDiv-${id}`);
        const rangeType = document.querySelector(`input[name="rangeType-${id}"]:checked`)?.value;

        if (pagesDiv && outlineDiv) {
            pagesDiv.style.display = rangeType === 'pages' ? 'block' : 'none';
            outlineDiv.style.display = rangeType === 'outline' ? 'block' : 'none';
        }
        updateRequiredDays(id);
        savePlanData(id);
    }
    
    function generatePlan() {
        const planData = {}; 
        const allPlans = Object.values(allPlansData);
        let earliestDate = null;
        let latestDate = null;

        allPlans.forEach(plan => {
            const id = plan.id;
            const startDateValue = plan.startDate;
            const endDateValue = plan.endDate;
            const dailyAmount = plan.dailyAmount;
            const items = getItemsArray(id);
            const itemsCount = items.length;

            if (!startDateValue || itemsCount === 0) return;

            const unitContent = plan.unit || '';
            const unitString = unitContent ? ` ${unitContent}` : ''; 
            const showStudy = plan.showStudy;
            const showReview = plan.showReview;
            const showCustom = plan.showCustom;
            const customText = plan.customText;
            const studyText = translations[currentLang].studyText;
            const reviewText = translations[currentLang].reviewText;
            let studyPrefix = studyText;
            let reviewPrefix = reviewText;
            if (showCustom && customText) {
                studyPrefix = customText;
                reviewPrefix = customText;
            }
            const shouldGeneratePrimaryTask = showStudy || (showCustom && customText.length > 0);
            let excludeWeekdays = plan.excludeWeekdays;
            let excludeDates = [];
            if (plan.useExcludeDates) {
                const datesStr = plan.excludeDates || '';
                const referenceYear = new Date(startDateValue).getFullYear();
                datesStr.split(/[\n,]/).forEach(dateStr => {
                    const yyyymmdd = parseDateInputToYYYYMMDD(dateStr, referenceYear);
                    if (yyyymmdd) excludeDates.push(yyyymmdd);
                });
            }
            let executionDates = [];
            if (plan.useExecutionDates) {
                const datesStr = plan.executionDates || '';
                const referenceYear = new Date(startDateValue).getFullYear();
                datesStr.split(/[\n,]/).forEach(dateStr => {
                    const yyyymmdd = parseDateInputToYYYYMMDD(dateStr, referenceYear);
                    if (yyyymmdd) executionDates.push(yyyymmdd);
                });
                executionDates = [...new Set(executionDates)].sort(); 
            }

            const color = plan.color;
            let itemIndex = 0;
            let currentDate = new Date(startDateValue);
            let limitDate = endDateValue ? new Date(endDateValue) : null;
            
            if (plan.useExecutionDates && executionDates.length > 0) {
                executionDates.forEach(dateStr => {
                    if (itemIndex >= itemsCount) return; 
                    const date = new Date(dateStr);
                    if (!isExcluded(date, excludeWeekdays, excludeDates)) {
                        const dateKey = getDateStr(date);
                        if (!planData[dateKey]) planData[dateKey] = [];
                        const studiedItems = [];
                        for (let i = 0; i < dailyAmount && itemIndex < itemsCount; i++) {
                            studiedItems.push(items[itemIndex++]);
                        }
                        if (studiedItems.length > 0 && shouldGeneratePrimaryTask) {
                             const rangeString = getRangeString(studiedItems);
                             const studyTask = {
                                 planId: id,
                                 text: `${studyPrefix}: ${rangeString}${unitString}`,
                                 color: color,
                                 isStudy: true,
                                 item: rangeString,
                                 unit: unitContent,
                             };
                             planData[dateKey].push(studyTask);
                        }
                        scheduleReviews(date, studiedItems, planData, id, reviewPrefix, showReview, excludeWeekdays, excludeDates, unitString);
                        if (!earliestDate || date < earliestDate) earliestDate = date;
                        if (!latestDate || date > latestDate) latestDate = date;
                    }
                });
            } else {
                while (itemIndex < itemsCount) {
                    const dateKey = getDateStr(currentDate);
                    if (limitDate && currentDate > limitDate) break; 
                    if (!isExcluded(currentDate, excludeWeekdays, excludeDates)) {
                        if (!planData[dateKey]) planData[dateKey] = [];
                        const studiedItems = [];
                        for (let i = 0; i < dailyAmount && itemIndex < itemsCount; i++) {
                            studiedItems.push(items[itemIndex++]);
                        }
                        if (studiedItems.length > 0 && shouldGeneratePrimaryTask) {
                             const rangeString = getRangeString(studiedItems);
                             const studyTask = {
                                 planId: id,
                                 text: `${studyPrefix}: ${rangeString}${unitString}`,
                                 color: color,
                                 isStudy: true,
                                 item: rangeString,
                                 unit: unitContent,
                             };
                             planData[dateKey].push(studyTask);
                        }
                        scheduleReviews(currentDate, studiedItems, planData, id, reviewPrefix, showReview, excludeWeekdays, excludeDates, unitString);
                        if (!earliestDate || currentDate < earliestDate) earliestDate = currentDate;
                        if (!latestDate || currentDate > latestDate) latestDate = currentDate;
                    }
                    if (itemIndex >= itemsCount) break;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
        });
        
        latestPlan = planData;
        renderCalendar(planData);
        updateSelectAllCheckboxState(); 
    }

    function scheduleReviews(studyDate, studyItems, allPlans, id, reviewPrefix, showReview, excludeWeekdays, excludeDates, unitString = '') {
        if (!showReview || studyItems.length === 0) return;
        const intervals = [1, 2, 4, 7, 15];
        const color = planColors[id];
        intervals.forEach(offset => {
            let reviewDate = new Date(studyDate);
            reviewDate.setDate(reviewDate.getDate() + offset);
            let rDate = new Date(reviewDate);
            let maxReviewSearchDays = 60; 
            let searchCount = 0;
            while (isExcluded(rDate, excludeWeekdays, excludeDates) && searchCount < maxReviewSearchDays) {
                rDate.setDate(rDate.getDate() + 1);
                searchCount++;
            }
            if (searchCount >= maxReviewSearchDays) return; 
            let rDateStr = getDateStr(rDate);
            const reviewTask = {
                planId: id,
                text: `${reviewPrefix}: ${getRangeString(studyItems)}${unitString}`, 
                color: color,
                isStudy: false,
                item: getRangeString(studyItems),
                unit: unitString,
            };
            if (!allPlans[rDateStr]) allPlans[rDateStr] = [];
            allPlans[rDateStr].push(reviewTask);
        });
    }

    function isLightColor(hexColor) {
        const c = hexColor.substring(1); 
        const rgb = parseInt(c, 16); 
        const r = (rgb >> 16) & 0xff; 
        const g = (rgb >> 8) & 0xff; 
        const b = (rgb >> 0) & 0xff; 
        const luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
        return luma > 200; 
    }

    function renderCalendar(planData) {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';
        const dates = Object.keys(planData);
        let startDate = new Date();
        let endDate = new Date();
        const todayKey = getDateStr(new Date());

        if (dates.length > 0) {
            dates.sort();
            startDate = new Date(dates[0]);
            endDate = new Date(dates[dates.length - 1]);
        } else {
            startDate.setDate(1);
            endDate.setMonth(endDate.getMonth() + 2); 
            endDate.setDate(0);
        }

        startDate.setDate(1);
        endDate.setMonth(endDate.getMonth() + 1);
        endDate.setDate(0); 

        let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

        while (currentMonth <= endDate) {
            const monthId = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
            const monthContainer = document.createElement('div');
            monthContainer.className = 'month-container';

            const monthHeader = document.createElement('div');
            monthHeader.className = 'month-header';
            monthHeader.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleMonthContent('${monthId}')">
                    <span>${currentMonth.getFullYear()} / ${currentMonth.getMonth() + 1}</span>
                    <span id="month-toggle-${monthId}" class="toggle-icon">▲</span>
                </div>
            `;
            monthContainer.appendChild(monthHeader);

            const contentWrapper = document.createElement('div');
            contentWrapper.id = `month-content-${monthId}`;
            contentWrapper.className = 'month-content-wrapper';
            contentWrapper.style.transition = 'max-height 0.3s ease-out';
            contentWrapper.style.overflow = 'hidden';
            monthContainer.appendChild(contentWrapper);

            const grid = createMonthGrid(currentMonth.getFullYear(), currentMonth.getMonth(), planData, todayKey, monthId);
            contentWrapper.appendChild(grid);
            calendar.appendChild(monthContainer);
            
            if (localStorage.getItem(`month-collapsed-${monthId}`) === 'true') {
                 contentWrapper.style.maxHeight = '0';
                 document.getElementById(`month-toggle-${monthId}`).textContent = '▼';
            } else {
                 contentWrapper.style.maxHeight = '3000px'; 
            }
            currentMonth.setMonth(currentMonth.getMonth() + 1);
        }
    }

    function createMonthGrid(year, month, planData, todayKey, monthId) {
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        const weekdayNames = currentLang === 'zh' ? weekdayMap : weekdayMap_en;

        for (let i = 0; i < 7; i++) {
            const dayHeader = document.createElement('div');
            dayHeader.className = `weekday-header${(i === 0 || i === 6) ? ' weekday-weekend' : ''}`;
            dayHeader.textContent = weekdayNames[i];
            grid.appendChild(dayHeader);
        }

        let firstDayOfMonth = new Date(year, month, 1);
        let startOffset = firstDayOfMonth.getDay();
        for (let i = 0; i < startOffset; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-day';
            grid.appendChild(emptyDiv);
        }

        let dayCursor = firstDayOfMonth;
        while (dayCursor.getMonth() === month) {
            const d = dayCursor.getDate();
            const dayOfWeek = dayCursor.getDay(); 
            const dateKey = getDateStr(dayCursor);
            const tasks = planData[dateKey] || [];
            const hasTasks = tasks.length > 0;
            const isToday = dateKey === todayKey;

            const day = document.createElement("div");
            day.className = `day ${isToday ? 'today' : ''}`;

            const dateHeaderContainer = document.createElement('div');
            dateHeaderContainer.className = 'date-header-container';
            dateHeaderContainer.style.display = 'flex';
            dateHeaderContainer.style.justifyContent = 'space-between';

            const dateOnlySpan = document.createElement('span');
            dateOnlySpan.className = 'date-only';
            dateOnlySpan.textContent = d;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'day-checkbox';
            checkbox.dataset.date = dateKey;
            
            // Set checkbox state
            if (!hasTasks) {
                checkbox.style.visibility = 'hidden';
            } else {
                checkbox.checked = true; // Default to checked
            }
            checkbox.onchange = updateDaySelection;

            dateHeaderContainer.appendChild(dateOnlySpan);
            dateHeaderContainer.appendChild(checkbox);
            day.appendChild(dateHeaderContainer);

            tasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task';
                taskDiv.textContent = task.text;
                const bgColor = task.color;
                taskDiv.style.backgroundColor = bgColor;
                taskDiv.style.borderLeftColor = shadeColor(bgColor, -20);
                
                if (isLightColor(bgColor)) taskDiv.style.color = '#3B3E3D';
                else taskDiv.style.color = '#FFFFFF';

                day.appendChild(taskDiv);
            });
            grid.appendChild(day);
            dayCursor.setDate(dayCursor.getDate() + 1);
        }

        let endOffset = 7 - grid.children.length % 7;
        if (endOffset < 7 && endOffset > 0) {
            for (let i = 0; i < endOffset; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-day';
                grid.appendChild(emptyDiv);
            }
        }
        return grid;
    }
    
    function shadeColor(color, percent) {
        var R = parseInt(color.substring(1,3),16);
        var G = parseInt(color.substring(3,5),16);
        var B = parseInt(color.substring(5,7),16);
        R = parseInt(R * (100 + percent) / 100);
        G = parseInt(G * (100 + percent) / 100);
        B = parseInt(B * (100 + percent) / 100);
        R = (R<255)?R:255;  
        G = (G<255)?G:255;  
        B = (B<255)?B:255;  
        var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
        var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
        var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
        return "#"+RR+GG+BB;
    }

    function updateDaySelection(event) {
        // Selection is transient (not saved to storage)
        updateSelectAllCheckboxState();
    }

    function updateSelectAllCheckboxState() {
        const allCheckboxes = document.querySelectorAll('.day-checkbox');
        const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => cb.style.visibility !== 'hidden');
        let checkedCount = 0;
        visibleCheckboxes.forEach(checkbox => {
             if (checkbox.checked) checkedCount++;
        });
        const selectAllCheckbox = document.getElementById('selectAllDays');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = visibleCheckboxes.length > 0 && checkedCount === visibleCheckboxes.length;
        }
    }

    function toggleMonthContent(monthId) {
        const content = document.getElementById(`month-content-${monthId}`);
        const icon = document.getElementById(`month-toggle-${monthId}`);
        if (content && icon) {
            const isCollapsed = content.style.maxHeight === '0px';
            if (!isCollapsed) { // Collapse it
                content.style.maxHeight = '0px';
                icon.textContent = '▼';
                localStorage.setItem(`month-collapsed-${monthId}`, 'true');
            } else { // Expand it
                content.style.maxHeight = '3000px';
                icon.textContent = '▲';
                localStorage.removeItem(`month-collapsed-${monthId}`);
            }
        }
    }

    function randomizeColor(id) {
        const color = getRandomColor();
        document.getElementById(`colorPicker-${id}`).value = color;
        document.querySelector(`.plan-group[data-id="${id}"]`).style.borderLeft = `5px solid ${color}`;
        planColors[id] = color;
        savePlanData(id); 
    }

    function updatePlanTitle(id) {
        const titleElement = document.getElementById(`plan-title-${id}`);
        const unitInput = document.getElementById(`unit-${id}`);
        if (titleElement) {
            const unit = unitInput?.value?.trim();
            const headerText = translations[currentLang].planHeader;
            titleElement.textContent = unit ? `${unit}` : `${headerText} #${id}`;
        }
        savePlanData(id);
    }
    
    function toggleCustomText(id) {
        const customDiv = document.getElementById(`customTextDiv-${id}`);
        const checkbox = document.getElementById(`showCustomCheckbox-${id}`);
        if (customDiv && checkbox) {
            customDiv.style.display = checkbox.checked ? 'block' : 'none';
            savePlanData(id); 
        }
    }

    function toggleExcludeDatesInput(id) {
        const customDiv = document.getElementById(`excludeDatesDiv-${id}`);
        const checkbox = document.getElementById(`excludeCustomDates-${id}`);
        if (customDiv && checkbox) {
            customDiv.style.display = checkbox.checked ? 'block' : 'none';
            savePlanData(id); 
        }
    }

    function toggleExecutionDatesInput(id) {
        const customDiv = document.getElementById(`executionDatesDiv-${id}`);
        const checkbox = document.getElementById(`useExecutionDatesCheckbox-${id}`);
        if (customDiv && checkbox) {
            customDiv.style.display = checkbox.checked ? 'block' : 'none';
            savePlanData(id); 
        }
    }

    function formatTaskForCalendar(taskObj) {
        const planTitle = document.getElementById(`unit-${taskObj.planId}`)?.value.trim() || (currentLang === 'zh' ? `記憶計劃 #${taskObj.planId}` : `Memory Plan #${taskObj.planId}`);
        return `${planTitle}: ${taskObj.text}`;
    }

    function addToGoogleCalendar() {
        if (Object.keys(latestPlan).length === 0) {
            alert(currentLang === 'zh' ? '請先產生記憶計劃！' : 'Please generate the memory plan first!');
            return;
        }
        const gcTitleOption = document.querySelector('input[name="gcTitleOption"]:checked').value;
        const keys = Object.keys(latestPlan).sort();
        
        const checkboxes = document.querySelectorAll('.day-checkbox');
        let selectedDates = {};
        checkboxes.forEach(cb => {
            if(cb.checked) selectedDates[cb.dataset.date] = true;
        });

        let urlsToOpen = [];

        keys.forEach(dateStr => {
            if (selectedDates[dateStr]) {
                const tasks = latestPlan[dateStr];
                if (gcTitleOption === 'merge') {
                    const mergedTasksText = tasks.map(t => t.text).join(' / ');
                    const representativeTask = tasks.find(t => t.isStudy) || tasks[0];
                    if (!representativeTask) return;
                    const unitInput = document.getElementById(`unit-${representativeTask.planId}`);
                    const planTitle = unitInput ? unitInput.value : (currentLang === 'zh' ? `記憶計劃` : `Memory Plan`);
                    const mergedTitle = `${planTitle} - ${mergedTasksText}`;
                    const mergedDescription = tasks.map(t => `• ${t.text}`).join('\n');
                    const date = new Date(dateStr);
                    const startYear = date.getFullYear();
                    const startMonth = date.getMonth() + 1;
                    const startDate = date.getDate();
                    const title = encodeURIComponent(mergedTitle);
                    const details = encodeURIComponent(mergedDescription);
                    const dates = `${startYear}${String(startMonth).padStart(2, '0')}${String(startDate).padStart(2, '0')}`;
                    
                    urlsToOpen.push(`https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&dates=${dates}/${dates}&sf=true&output=xml`);
                } else {
                    // SEPARATE LOGIC
                    tasks.forEach(taskObj => {
                        const date = new Date(dateStr);
                        const startYear = date.getFullYear();
                        const startMonth = date.getMonth() + 1;
                        const startDate = date.getDate();
                        const title = encodeURIComponent(formatTaskForCalendar(taskObj));
                        const details = encodeURIComponent(taskObj.text);
                        const dates = `${startYear}${String(startMonth).padStart(2, '0')}${String(startDate).padStart(2, '0')}`;
                        
                        urlsToOpen.push(`https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&dates=${dates}/${dates}&sf=true&output=xml`);
                    });
                }
            }
        });

        if (urlsToOpen.length === 0) {
            alert(currentLang === 'zh' ? '請勾選至少一個日期！' : 'Please check at least one day!');
            return;
        }

        // Execute opens
        urlsToOpen.forEach((url, index) => {
            // Using a small timeout helps separate the calls, 
            // though browsers might still block >1 popups.
            setTimeout(() => {
                window.open(url, '_blank');
            }, index * 300);
        });
    }

    function downloadCSV() {
        if (Object.keys(latestPlan).length === 0) {
            alert(currentLang === 'zh' ? '請先產生記憶計劃！' : 'Please generate the memory plan first!');
            return;
        }
        const gcTitleOption = document.querySelector('input[name="gcTitleOption"]:checked').value;
        const keys = Object.keys(latestPlan).sort();
        
        // DOM selection check
        const checkboxes = document.querySelectorAll('.day-checkbox');
        let selectedDates = {};
        checkboxes.forEach(cb => {
            if(cb.checked) selectedDates[cb.dataset.date] = true;
        });

        let csv = "Subject,Start Date,Start Time,End Date,End Time,All Day Event,Description,Location\n";
        const rows = [];
        const emptyFields = ',,'; 
        const allDayEvent = 'TRUE';

        if (gcTitleOption === 'merge') {
            keys.forEach(dateStr => {
                if (selectedDates[dateStr]) { 
                    const tasks = latestPlan[dateStr];
                    const mergedTasksText = tasks.map(t => t.text).join(' / ');
                    const representativeTask = tasks.find(t => t.isStudy) || tasks[0];
                    if (!representativeTask) return;
                    const unitInput = document.getElementById(`unit-${representativeTask.planId}`);
                    const planTitle = unitInput ? unitInput.value : (currentLang === 'zh' ? `記憶計劃` : `Memory Plan`);
                    const subject = `"${planTitle} - ${mergedTasksText}"`;
                    const dateParts = dateStr.split('-');
                    const csvDateStr = `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}/${dateParts[0]}`;
                    const row = `${subject},${csvDateStr}${emptyFields}${csvDateStr}${emptyFields}${allDayEvent},,`;
                    rows.push(row);
                }
            });
        } else {
            keys.forEach(dateStr => {
                if (selectedDates[dateStr]) { 
                    latestPlan[dateStr].forEach(taskObj => {
                        const subject = `"${formatTaskForCalendar(taskObj)}"`;
                        const dateParts = dateStr.split('-');
                        const csvDateStr = `${parseInt(dateParts[1])}/${parseInt(dateParts[2])}/${dateParts[0]}`;
                        const row = `${subject},${csvDateStr}${emptyFields}${csvDateStr}${emptyFields}${allDayEvent},,`;
                        rows.push(row);
                    });
                }
            });
        }
        csv += rows.join("\n");
        // Added \uFEFF (BOM) to fix Excel encoding issue
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", "google_calendar_import.csv");
        link.click();
    }

    function toggleAllCheckboxes() {
        const selectAll = document.getElementById('selectAllDays').checked;
        document.querySelectorAll('.day-checkbox').forEach(checkbox => {
            if (checkbox.style.visibility !== 'hidden') {
                checkbox.checked = selectAll;
            }
        });
    }

    function toggleTheme() {
        const body = document.body;
        const button = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');
        const themeTextSpan = button ? button.querySelector('[data-i18n-id="toggleThemeBtn"]') : null;
        
        const isDark = body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');

        if(themeIcon) {
            themeIcon.classList.remove(isDark ? 'fa-moon' : 'fa-sun');
            themeIcon.classList.add(isDark ? 'fa-sun' : 'fa-moon');
        }
        if(themeTextSpan) {
            themeTextSpan.textContent = isDark 
                ? (currentLang === 'zh' ? '日間' : 'Light') 
                : (currentLang === 'zh' ? '夜間' : 'Dark');
        }

        // Update palettes when theme changes
        Object.keys(allPlansData).forEach(id => {
            renderPaletteSuggestions(id);
        });
    }

    function toggleLanguage() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        localStorage.setItem('language', currentLang);
        applyTranslation(currentLang);
        renderPlans(); 
        generatePlan(); 
        loadTheme();
    }

    function applyTranslation(lang) {
        const t = translations[lang];
        const titleElement = document.querySelector('title');
        const titleKey = titleElement.getAttribute('data-i18n');
        if (t[titleKey]) titleElement.textContent = t[titleKey];

        document.querySelectorAll('[data-i18n], [data-i18n-id]').forEach(element => {
            const key = element.getAttribute('data-i18n') || element.getAttribute('data-i18n-id');
            if (element.tagName === 'BUTTON' || element.tagName === 'H1') {
                if (t[key]) {
                    const icon = element.querySelector('i');
                    if(icon) {
                         const span = element.querySelector('span');
                         if(span) span.textContent = t[key];
                         else element.childNodes[element.childNodes.length-1].nodeValue = t[key];
                    } else {
                        element.textContent = t[key];
                    }
                }
            } 
            else if (element.tagName === 'SPAN' || element.tagName === 'LABEL' || element.tagName === 'P') {
                if (t[key]) {
                    if (element.children.length === 0) element.textContent = t[key];
                    else if (element.tagName === 'LABEL' && element.querySelector('span')) {
                        const textSpan = element.querySelector('span');
                        if (textSpan) textSpan.textContent = t[key];
                    }
                }
            }
        });

        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            if (t[key]) element.placeholder = t[key];
        });

        renderPlans();
        Object.keys(allPlansData).map(Number).forEach(id => {
            updatePlanTitle(id);
            updateRequiredDays(id);
        });
        loadTheme();
    }

    function loadLanguage() {
        const savedLang = localStorage.getItem('language');
        if (savedLang && translations[savedLang]) currentLang = savedLang;
        applyTranslation(currentLang);
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        const body = document.body;
        const button = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon'); 
        const themeTextSpan = button ? button.querySelector('[data-i18n-id="toggleThemeBtn"]') : null;
        
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            if(themeIcon) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
            if(themeTextSpan) themeTextSpan.textContent = currentLang === 'zh' ? '日間' : 'Light'; 
        } else {
            body.classList.remove('dark-mode');
            if(themeIcon) {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
            if(themeTextSpan) themeTextSpan.textContent = currentLang === 'zh' ? '夜間' : 'Dark'; 
        }
    }

    function initVisitCount() {
        let count = localStorage.getItem('site_visits');
        if (!count) {
            count = 0;
        } else {
            count = parseInt(count) + 1;
        }
        localStorage.setItem('site_visits', count);
        document.getElementById('visitor-count').textContent = count.toLocaleString();
    }

    loadPlansData();
    loadLanguage();
    loadTheme();
    if (Object.keys(allPlansData).length === 0) addPlan(); 
    generatePlan(); 
    setTimeout(updateSelectAllCheckboxState, 100); 
    initVisitCount(); // Initialize Counter

</script>
</body>
</html>
